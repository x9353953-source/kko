<!DOCTYPE html>
<html lang="zh-CN">
<head>
<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾Ultimate (Pro Max)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1685/1685230.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script><style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            color: #000000;-webkit-tap-highlight-color: transparent;
            padding-bottom: 200px;
            overscroll-behavior-y: none;
        }
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* iOS å¡ç‰‡æ ·å¼ */
        .ios-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            margin-bottom: 20px;
            contain: content; 
        }
        /* åˆ—è¡¨åˆ†å‰²çº¿ */
        .ios-divide > div:not(:last-child), 
        .ios-divide > label:not(:last-child),
        .ios-divide > details > .divide-y > div:not(:last-child) { border-bottom: 0.5px solid #C6C6C8; }
        
        /* è¾“å…¥æ¡†é‡ç½® */
        input[type=number], select, input[type=text] { appearance: none; -webkit-appearance: none; background: transparent; }
        
        /* iOS æ»‘åŠ¨æ¡ */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 24px; margin: 0; padding: 0; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #E5E5EA; border-radius: 2px; border: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; background: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: 0.5px solid rgba(0,0,0,0.04); margin-top: -9px; transition: transform 0.1s; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }/* åŠ¨ç”»ä¸æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .checkered-bg { background-color: #eee; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
        .action-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #F2F2F7; border-top-left-radius: 16px; border-top-right-radius: 16px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 101; padding: 20px; padding-bottom: 40px; }
        .action-sheet.show { transform: translateY(0); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç»“æœåŒºåŸŸ - ä¿®æ­£ï¼šç§»é™¤é«˜åº¦é™åˆ¶ï¼Œå…è®¸é¡µé¢è‡ªç„¶æ»šåŠ¨ */
        .result-scroll-container {
            /* å…³é”®ä¿®æ”¹ï¼šå–æ¶ˆ max-height å’Œ overflow-yï¼Œè®©å›¾ç‰‡è‡ªåŠ¨æ’‘å¼€é¡µé¢ */
            min-height: 100px;
            background: #f9f9f9;
            border-radius: 12px;
            padding: 10px;
            contain: content;
        }
        
        /* æ‹–æ‹½ä¸Šä¼ é®ç½© */
        #dragOverlay {
            position: fixed; inset: 0; background: rgba(0,122,255,0.1); backdrop-filter: blur(2px);
            z-index: 999; display: none; justify-content: center; align-items: center;
            border: 4px dashed #007AFF; margin: 10px; border-radius: 20px; pointer-events: none;
        }
        #dragOverlay.active { display: flex; }
        .sortable-ghost { opacity: 0.4; background: #E5E5EA; } 
        
        #imageGrid {
            content-visibility: auto; 
            contain-intrinsic-size: 300px;
        }
        .thumbnail-item { 
            contain: paint layout; 
        }
        
        #progressBarContainer { display: none !important; }
    </style>
</head>
<body class="antialiased"><div id="dragOverlay"><div class="text-[#007AFF] font-bold text-2xl bg-white/90 px-6 py-3 rounded-xl shadow-lg">æ¾æ‰‹é‡Šæ”¾å›¾ç‰‡</div></div>

    <header class="sticky top-0 z-50 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-gray-200/50 supports-[backdrop-filter]:bg-[#F2F2F7]/60">
        <div class="max-w-2xl mx-auto px-5 py-3 flex justify-between items-center h-[52px]">
            <h1 class="text-[22px] font-bold tracking-tight text-black">æ‹¼å›¾æ’åº<span class="text-xs font-normal text-white bg-black px-1.5 py-0.5 rounded ml-1">Ultimate</span></h1>
            <div class="flex items-center gap-2">
                <button onclick="hardReset()" class="bg-gray-100 text-gray-500 text-[13px] font-bold px-3 py-1.5 rounded-full shadow-sm active:bg-gray-200 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    é‡ç½®
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-white text-[#007AFF] text-[15px] font-bold px-4 py-1.5 rounded-full shadow-sm active:bg-gray-100 transition flex items-center gap-1">
                    <svg class="w-4 h-4 stroke-[3px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                    æ·»åŠ 
                </button>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
            <input type="file" id="replaceInput" accept="image/*" class="hidden" onchange="handleReplaceAction(this.files)">
            <input type="file" id="stickerInput" accept="image/*" class="hidden" onchange="handleStickerFile(this.files)">
        </div>
    </header><main class="max-w-2xl mx-auto px-4 pt-4 relative">
        <div id="progressToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] transition-all duration-200 cubic-bezier(0.34, 1.56, 0.64, 1) -translate-y-[200%] opacity-0 pointer-events-none">
            <div class="bg-white/95 backdrop-blur-xl text-gray-900 rounded-full shadow-2xl flex items-center py-3 pl-6 pr-4 gap-3 border border-gray-200/50 min-w-[200px]">
                <div class="flex-1 flex flex-col justify-center min-w-0">
                    <div class="flex items-center justify-center gap-2">
                        <span id="progressText" class="text-[15px] font-bold leading-tight truncate text-[#007AFF]">å‡†å¤‡ä¸­...</span>
                        <span id="progressDetail" class="text-[13px] text-gray-400 font-mono hidden">0%</span>
                    </div>
                </div>
                <button onclick="cancelProcess()" class="pointer-events-auto w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 active:scale-90 transition text-gray-500 hover:text-[#FF3B30] shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        
        <div class="ios-card">
            <details class="group" open>
                <summary class="flex justify-between items-center p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <span class="text-[13px] text-gray-500 uppercase font-medium pl-1">
                        å·²å¯¼å…¥ <span id="countBadge">0</span> å¼  
                        <span class="text-[10px] text-[#007AFF] bg-[#007AFF]/10 px-1.5 py-0.5 rounded ml-2 font-bold">æ”¯æŒé•¿æŒ‰æ‹–æ‹½æ’åº</span>
                    </span>
                    <div class="flex items-center gap-3">
                        <button onclick="event.preventDefault(); event.stopPropagation(); clearAll()" class="text-[#FF3B30] text-[13px] active:opacity-50 transition hidden" id="clearBtn">æ¸…ç©º</button>
                        <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </summary>
                
                <div class="p-4 pt-0 border-t border-gray-100">
                    <div id="imageGrid" class="grid grid-cols-4 gap-2 overflow-y-auto max-h-[220px] min-h-[100px] no-scrollbar touch-pan-y mt-4">
                        <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-8 space-y-3">
                            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <span class="text-gray-400 text-sm">å¯¼å…¥å›¾ç‰‡ (ç‚¹å‡»å¯æ›¿æ¢/é•¿æŒ‰æ‹–æ‹½)</span>
                        </div>
                    </div>
                    <div id="duplicateAlert" class="hidden mt-3 bg-yellow-50 border border-yellow-100 rounded-lg p-3 text-xs text-yellow-700 flex items-start gap-2">
                        <span class="font-bold">å‘ç°é‡å¤å›¾ç‰‡ï¼š</span> <span id="dupCount">0</span> å¼ ã€‚
                        <button onclick="removeDuplicates()" class="underline text-yellow-800 font-bold ml-1">ä¸€é”®å»é‡</button>
                    </div>
                </div>
            </details>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">å•å…ƒæ ¼ä¸é—´è·</div>
        <div class="ios-card">
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] font-bold">å•å…ƒæ ¼ä¸é—´è·è®¾ç½®</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">è®¾ç½®ç”»å¸ƒæ¯”ä¾‹ã€ç•™ç™½é—´éš™</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                
                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    <div class="p-4 bg-white active:bg-gray-50 transition relative">
                        <div class="flex items-center justify-between">
                            <span class="text-[17px]">ç”»å¸ƒæ¯”ä¾‹</span><div class="flex items-center gap-2">
                                <select id="aspectRatio" onchange="toggleCustomRatio()" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none text-right appearance-none cursor-pointer dir-rtl">
                                    <option value="0.5625">9:16 æ‰‹æœºå…¨å±</option>
                                    <option value="0.75">3:4 æµ·æŠ¥</option>
                                    <option value="1">1:1 æ­£æ–¹å½¢</option>
                                    <option value="1.333">4:3 ç…§ç‰‡</option>
                                    <option value="custom">è‡ªå®šä¹‰...</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1">è®¾ç½®å•å¼ å›¾ç‰‡çš„å®½é«˜æ¯”ä¾‹</div>
                    </div>
                    <div class="p-4 bg-white active:bg-gray-50 transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[17px]">å›¾ç‰‡é—´éš™</span>
                            <span id="gapValueDisplay" class="text-[#007AFF] font-bold text-[15px]">0px</span>
                        </div>
                        <input type="range" id="gap" min="0" max="100" value="0" step="1" oninput="document.getElementById('gapValueDisplay').innerText=this.value+'px'">
                        <div class="text-[10px] text-gray-400 mt-1">è®¾ç½®å›¾ç‰‡ä¹‹é—´çš„ç•™ç™½è·ç¦»</div>
                    </div>
                    
                    <div id="customRatioBox" class="hidden p-4 bg-gray-50 flex items-center justify-end gap-3 border-t border-gray-100">
                        <input type="number" id="customW" placeholder="å®½" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1000">
                        <span class="text-gray-400">:</span>
                        <input type="number" id="customH" placeholder="é«˜" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1500">
                    </div>
                </div>
            </details>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">åºå·æ ‡æ³¨</div>
        <div class="ios-card ios-divide">
            <div class="flex items-center justify-between p-4 bg-white">
                <span class="text-[17px]">æ˜¾ç¤ºåºå·</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="showNum" checked class="sr-only peer">
                    <div class="w-[51px] h-[31px] bg-[#E9E9EA] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-[27px] after:w-[27px] after:shadow-sm after:transition-all peer-checked:bg-[#34C759]"></div>
                </label>
            </div>
            
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] text-[#007AFF]">åºå·è¯¦ç»†è®¾ç½®</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">è®¾ç½®åºå·å¤§å°ã€é¢œè‰²ã€å­—ä½“ã€èµ·å§‹ä½ç½®</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                
                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">èµ·å§‹æ•°å€¼</span>
                        <input type="number" id="startNumber" value="1" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20 bg-transparent rounded px-2 py-1" placeholder="1">
                    </div><div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">å­—å·å¤§å°</span>
                        <input type="number" id="fontSize" value="350" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20 bg-transparent rounded px-2 py-1" placeholder="150">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">å­—ä½“é¢œè‰²</span>
                        <div class="flex items-center gap-2">
                            <input type="color" id="fontColor" value="#FFFFFF" class="w-8 h-8 rounded-full overflow-hidden border border-gray-200">
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">é˜´å½±é¢œè‰²</span>
                        <div class="flex items-center gap-2">
                            <input type="color" id="fontShadowColor" value="#000000" class="w-8 h-8 rounded-full overflow-hidden border border-gray-200">
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">å­—ä½“ç±»å‹</span>
                        <select id="fontFamily" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl text-right w-40" onchange="saveSettings()">
                            <option value="sans-serif">é»˜è®¤ (æ— è¡¬çº¿)</option>
                            <option value="'Heiti SC', 'Microsoft YaHei', sans-serif">é»‘ä½“ (Bold)</option>
                            <option value="'Songti SC', 'SimSun', serif">å®‹ä½“ (Serif)</option>
                            <option value="'KaiTi', 'æ¥·ä½“', serif">æ¥·ä½“ (Calligraphy)</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="cursive">æ‰‹å†™é£ (Cursive)</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">ä½ç½®</span>
                        <select id="fontPos" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl">
                            <option value="bottom-center">åº•éƒ¨å±…ä¸­</option>
                            <option value="bottom-left">åº•éƒ¨å·¦ä¾§</option>
                            <option value="bottom-right">åº•éƒ¨å³ä¾§</option>
                            <option value="center">æ­£ä¸­é—´</option>
                            <option value="top-left">å·¦ä¸Šè§’</option>
                            <option value="top-right">å³ä¸Šè§’</option>
                        </select>
                    </div>
                </div>
            </details>
        </div><div id="unified-group-panel" class="ios-card mb-6">
             <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] font-bold">å¯¼å‡ºä¸å¸ƒå±€ç­–ç•¥</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">è®¾ç½®æ’åˆ—åˆ—æ•°ã€åˆ†ç»„æ–¹å¼ã€ç”»è´¨</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                
                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    <div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[17px] font-bold text-gray-800">æ’åˆ—ä¸åˆ†ç»„</span>
                        </div><div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                 <label class="text-[11px] text-gray-500 block mb-1">åˆ—æ•° (æ¨ªå‘)</label>
                                 <input type="number" id="cols" value="3" placeholder="é»˜è®¤:3" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="calculateGroupBatch()">
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                 <label class="text-[11px] text-gray-500 block mb-1">æ¯ç»„è¡Œæ•° (è‡ªåŠ¨)</label>
                                 <input type="number" id="group_rows" placeholder="é»˜è®¤:50" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="calculateGroupBatch()">
                            </div>
                        </div>
                        <div class="mt-3 text-[11px] text-gray-500 bg-[#F2F2F7] p-2 rounded flex items-center gap-2" id="group_hint">
                            <span class="font-bold">Ready</span> <span>é»˜è®¤å°†æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆä¸ºä¸€ç»„ï¼ˆè¶…è¿‡ä¸€ç™¾å¼ ä¸ä¼šç”Ÿæˆä¸€ç»„å›¾ç‰‡ï¼‰</span>
                        </div>
                    </div><div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex flex-col">
                                <span class="text-[17px] font-bold text-gray-800">å…¨å±€çº¹ç† / è¦†ç›–å±‚</span>
                                <span class="text-[10px] text-gray-400">æ°´å°/åº•çº¹ (æ— éœ€æ±‚å¯å¿½ç•¥)</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="previewOverlayEffect()" class="text-gray-600 text-[13px] font-bold bg-gray-100 border border-gray-200 px-3 py-1.5 rounded-full active:bg-gray-200 transition flex items-center gap-1">
                                    ğŸ‘ï¸ é¢„è§ˆ
                                </button>
                                <button onclick="document.getElementById('overlayInput').click()" class="text-[#007AFF] text-[13px] font-bold bg-[#007AFF]/10 px-3 py-1.5 rounded-full active:bg-[#007AFF]/20 transition">
                                    + å›¾ç‰‡
                                </button>
                            </div>
                            <input type="file" id="overlayInput" accept="image/*" class="hidden" onchange="handleOverlayFile(this.files)">
                        </div>
                        <div id="overlayInfoBox" class="hidden bg-gray-50 rounded-lg p-2 mb-3 flex items-center justify-between border border-gray-100">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <img id="overlayThumb" class="w-8 h-8 rounded object-cover border border-gray-200 bg-white">
                                <span id="overlayName" class="text-xs text-gray-500 truncate max-w-[150px]">filename.png</span>
                            </div>
                            <button onclick="clearOverlay()" class="text-gray-400 hover:text-[#FF3B30] px-2">âœ•</button>
                        </div><div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[11px] text-gray-500 block mb-1">æ··åˆæ¨¡å¼</label>
                                <select id="overlayMode" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 text-sm font-bold text-gray-700 outline-none">
                                    <option value="source-over">æ ‡å‡† (æ­£å¸¸)</option>
                                    <option value="multiply">æ­£ç‰‡å åº• (å˜æš—)</option>
                                    <option value="screen">æ»¤è‰² (å˜äº®/æ·»åŠ )</option>
                                    <option value="overlay">è¦†ç›– (å åŠ )</option>
                                    <option value="soft-light">æŸ”å…‰</option>
                                    <option value="difference">å·®å€¼</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[11px] text-gray-500 block mb-1">ä¸é€æ˜åº¦</label>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center h-[34px] bg-gray-50 border border-gray-200 rounded-lg px-2 flex-1">
                                        <input type="range" id="overlayOpacityRange" min="0" max="1" step="0.01" value="1" class="w-full h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="syncOpacity('range')">
                                    </div>
                                    <input type="number" id="overlayOpacityInput" min="0" max="1" step="0.01" value="1" class="w-14 h-[34px] bg-gray-50 border border-gray-200 rounded-lg text-center text-sm font-bold text-[#007AFF] outline-none" oninput="syncOpacity('input')">
                                </div>
                            </div>
                        </div>
                    </div><div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[17px] font-bold text-gray-800">å¯¼å‡ºç”»è´¨</span>
                            <div class="flex items-center gap-2">
                                <button onclick="previewQuality()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded flex items-center gap-1 transition"><span>ğŸ‘ï¸ é¢„è§ˆ</span></button>
                                <div class="relative w-14">
                                    <input type="number" id="customQ_unified" min="10" max="100" value="80" class="bg-gray-100 rounded px-1 py-1 text-center w-full text-[15px] font-bold text-[#007AFF] outline-none" placeholder="80" oninput="validateQualityInput(this)">
                                </div>
                                <span class="text-xs text-gray-500 mr-1">%</span>
                                <select id="exportQuality_unified" onchange="applyQualityPreset(this)" class="text-[#007AFF] text-[15px] bg-transparent focus:outline-none text-right dir-rtl cursor-pointer max-w-[140px]">
                                    <option value="none" selected disabled>ç”»è´¨é€‰æ‹©...</option>
                                    <option value="1.0">åŸå›¾ (PNG)</option>
                                    <option value="0.95">é«˜æ¸… (95%)</option>
                                    <option value="0.80">æ ‡å‡†å‹ç¼© (80%)</option>
                                    <option value="custom">è‡ªå®šä¹‰</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-[10px] text-[#FF3B30] mt-1 font-bold">âš ï¸ æ›´æ”¹ç”»è´¨åè¯·é‡æ–°ç”Ÿæˆæ‹¼å›¾ï¼Œè¯·è‡ªè¡Œè°ƒç”»è´¨ï¼Œå¦åˆ™ç”Ÿæˆå›¾ç‰‡è¿‡å¤§</div>
                        <div class="text-[10px] text-gray-400 leading-tight mt-1">
                            * çœŸå®æ–‡ä»¶å¤§å°å°†åœ¨ç”Ÿæˆåå‡†ç¡®è®¡ç®—å¹¶æ˜¾ç¤ºã€‚<br>
                            * å»ºè®®50%ï¼Œï¼ˆ30%ä¹Ÿä¸ä¼šå½±å“å¤ªå¤§ç”»è´¨æŸ¥çœ‹å›¾ç‰‡ï¼Œä¸ä¼šå›¾ç‰‡è¿‡å¤§ï¼‰ã€‚
                        </div>
                    </div>
                </div>
            </details>
        </div><div class="ios-card">
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] font-bold">æ‰“ç ä¸è´´çº¸</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">é®æŒ¡ç‰¹å®šå›¾ç‰‡æˆ–åºå·ã€æ·»åŠ è´´çº¸</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>

                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    <div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex flex-col">
                                <span class="text-[17px] font-bold text-gray-800">ç›®æ ‡åºå·</span>
                                <span class="text-[10px] text-gray-400">è¾“å…¥æ•°å­— (å¦‚: 5, 12, 1-3)</span>
                            </div>
                            <input type="text" id="maskIndices" placeholder="å¦‚: 5, 12" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-40 placeholder-gray-300 bg-gray-50 rounded px-2 py-1">
                        </div>

                        <div class="flex p-1 bg-gray-100 rounded-lg mb-4">
                            <button onclick="switchMaskTab('line')" id="tab-line" class="flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all">ç”»çº¿æ‰“ç </button>
                            <button onclick="switchMaskTab('image')" id="tab-image" class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">å›¾ç‰‡/è´´çº¸</button>
                        </div><div id="mask-panel-line" class="animate-fade-in">
                            <div class="flex justify-between items-center pb-3 border-b border-gray-100 mb-3">
                                <span class="text-sm text-gray-500">å½¢çŠ¶æ ·å¼</span>
                                <div class="flex items-center gap-4 text-sm">
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="lineStyle" value="cross" checked class="accent-[#FF3B30]"> <span>âŒ äº¤å‰</span></label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="lineStyle" value="slash" class="accent-[#FF3B30]"> <span>â•± æ–œçº¿</span></label>
                                </div>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                 <span class="text-sm text-gray-500 w-20">é¢œè‰²/ç²—ç»†</span>
                                 <div class="flex items-center flex-1 gap-3">
                                     <input type="color" id="maskColor" value="#FF3B30" class="w-8 h-8 rounded-full border border-gray-200 shrink-0">
                                     <div class="flex-1 h-8 flex items-center"><input type="range" id="maskWidth" min="1" max="20" value="10" class="w-full"></div>
                                 </div>
                            </div>
                        </div><div id="mask-panel-image" class="hidden animate-fade-in">
                            <button onclick="document.getElementById('stickerInput').click()" class="w-full py-2 border border-dashed border-gray-300 rounded-lg text-gray-500 text-sm mb-3 active:bg-gray-50">+ ä¸Šä¼ é®æŒ¡å›¾ (Logo/è´´çº¸)</button>
                            <div class="flex gap-4 mb-1">
                                <div class="w-24 h-24 checkered-bg rounded-lg overflow-hidden border border-gray-200 shrink-0 relative cursor-pointer active:scale-95 transition shadow-sm" onclick="enlargeStickerPreview()">
                                    <canvas id="stickerPreviewCanvas" class="w-full h-full object-contain"></canvas>
                                </div>
                                <div class="flex-1 flex flex-col justify-center space-y-4">
                                    <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">å¤§å°</span> <input type="range" id="stickerSize" min="10" max="200" value="50" class="flex-1"></div>
                                    <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">å·¦å³</span> <input type="range" id="stickerX" min="0" max="100" value="50" class="flex-1"></div>
                                    <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">ä¸Šä¸‹</span> <input type="range" id="stickerY" min="0" max="100" value="50" class="flex-1"></div>
                                </div>
                            </div>
                        </div>
                    </div><div class="p-4 pt-0 grid grid-cols-2 gap-3 bg-white pb-4">
                        <button onclick="generateMasked('apply')" class="py-3 rounded-xl bg-[#007AFF]/10 active:bg-[#007AFF]/20 text-[#007AFF] font-bold text-[15px] transition-all flex items-center justify-center gap-1">âœ¨ ç”Ÿæˆ/æ›´æ–°</button>
                        <button onclick="generateMasked('repack')" class="py-3 rounded-xl bg-[#FF3B30]/10 active:bg-[#FF3B30]/20 text-[#FF3B30] font-bold text-[15px] transition-all flex items-center justify-center gap-1">ğŸ”„ å‰”é™¤å¹¶é‡æ’</button>
                    </div>
                </div>
            </details>
        </div>

        <div id="resultArea" class="hidden pb-10">
            <div class="text-center text-gray-400 text-xs mb-3 font-medium">é¢„è§ˆç»“æœ (å·²ç”Ÿæˆ)</div>
            <div id="realSizeContainer" class="mb-4 bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800 hidden">
                <div class="flex justify-between items-center font-bold border-b border-green-200/50 pb-2 mb-2">
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ç”Ÿæˆå®Œæˆ
                    </span>
                    <span id="realTotalSize">0 MB</span>
                </div>
                <div id="combinedSizeTip" class="text-xs text-green-600 mb-2 hidden flex justify-between">
                    <span>è‹¥åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾çº¦:</span>
                    <span id="combinedSizeValue" class="font-bold">è®¡ç®—ä¸­...</span>
                </div>
                <div id="groupSizeDetail" class="pt-1 text-xs text-green-700 hidden grid grid-cols-2 gap-y-1"></div>
                <button onclick="toggleGroupSizes()" id="btnToggleSizes" class="text-[10px] underline mt-1 w-full text-left text-green-600 hidden">å±•å¼€åˆ†ç»„è¯¦æƒ… â–¼</button>
            </div><div class="ios-card bg-white p-0 shadow-lg border border-gray-100">
                <div class="result-scroll-container bg-gray-50/50">
                    <div id="seamlessContainer" class="w-full flex flex-col bg-white shadow-sm"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="confirmDownload('zip')" class="col-span-2 bg-[#34C759] text-white text-[16px] font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    <span>æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ†ç»„ (ZIP)</span>
                </button>
                <button onclick="confirmDownload('combine')" class="bg-white text-black border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾</button>
                <button onclick="confirmDownload('parts')" class="bg-white text-[#007AFF] border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">é€å¼ ä¸‹è½½</button>
            </div>
        </div>
        <div class="py-10 pb-20 text-center">
            <div class="space-y-1">
                <p class="text-xs text-gray-500 font-medium">æ‹¼å›¾Ultimate (Pro Max)</p>
                <p class="text-[10px] text-gray-400">Designed by ikko     ğŸˆ²äºŒä¼ </p>
            </div>
        </div>
    </main><div class="fixed bottom-8 left-0 right-0 px-4 z-40 pointer-events-none">
        <button onclick="generate()" class="pointer-events-auto w-full max-w-2xl mx-auto bg-white/80 backdrop-blur-md text-black border border-white/40 font-semibold text-[17px] py-3.5 rounded-full shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
            <span>âœ¨ å¼€å§‹ç”Ÿæˆæ‹¼å›¾</span>
        </button>
    </div>
    
    <canvas id="canvas" class="hidden"></canvas>
    
    <div id="previewModal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="bg-white p-2 rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center flex-col" style="max-width:90%; max-height:80%;" onclick="event.stopPropagation()">
            <div id="previewHeader" class="w-full text-center py-2 text-sm font-bold text-gray-500 hidden">ç”»è´¨é¢„è§ˆ</div>
            <canvas id="enlargedPreviewCanvas" class="object-contain hidden" style="max-width:100%; max-height:70vh;"></canvas>
            <img id="qualityPreviewImg" class="object-contain hidden" style="max-width:100%; max-height:70vh;">
            <button onclick="document.getElementById('previewModal').style.display='none'" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
    </div><div id="imageActionOverlay" class="modal-overlay" onclick="closeImageActions()"></div>
    <div id="imageActionSheet" class="action-sheet">
        <div class="text-center text-gray-400 text-sm mb-4 font-medium">å›¾ç‰‡æ“ä½œ</div>
        <div class="space-y-3">
            <button onclick="triggerReplace()" class="w-full bg-white text-[#007AFF] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">æ›¿æ¢å›¾ç‰‡</button>
            <button onclick="triggerDelete()" class="w-full bg-white text-[#FF3B30] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">åˆ é™¤å›¾ç‰‡</button>
        </div>
        <button onclick="closeImageActions()" class="w-full bg-white text-black font-semibold text-[17px] py-3.5 rounded-xl shadow-sm mt-4 active:bg-gray-50">å–æ¶ˆ</button>
    </div>
    
    <div id="resetAlert" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/40 transition-opacity duration-200 opacity-0" id="resetBackdrop"></div>
        <div class="relative bg-[#F2F2F2]/85 backdrop-blur-xl rounded-[14px] w-[270px] text-center shadow-2xl transform scale-110 transition-all duration-200 opacity-0 overflow-hidden" id="resetModal">
            <div class="pt-5 px-4 pb-4">
                <h3 class="text-[17px] font-bold text-black mb-1">âš ï¸ è­¦å‘Š</h3>
                <p class="text-[13px] text-black leading-snug">ç¡®å®šè¦é‡ç½®å—ï¼Ÿ<br>è¿™å°†æ¸…ç©ºæ‰€æœ‰å†…å®¹ã€‚</p>
            </div>
            <div class="flex border-t border-[#3C3C43]/30 h-[44px]">
                <button onclick="closeResetAlert()" class="flex-1 text-[17px] text-[#007AFF] font-normal active:bg-gray-200/50 transition border-r border-[#3C3C43]/30">å–æ¶ˆ</button>
                <button onclick="confirmResetAction()" class="flex-1 text-[17px] text-[#FF3B30] font-bold active:bg-gray-200/50 transition">é‡ç½®</button>
            </div>
        </div>
    </div>
    
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(registration => {
                console.log('SW æ³¨å†ŒæˆåŠŸ:', registration.scope);
            }, err => {
                console.log('SW æ³¨å†Œå¤±è´¥:', err);
            });
        });
    }
    </script><script>
    let imagesData = [];
    let generatedBlobs = []; 
    let stickerImg = null;
    let currentMaskMode = 'line';
    let targetImageIndex = -1; 
    let isCancelled = false;
    let globalOverlayImg = null; 
    let sortableInstance = null;
    const MAX_CANVAS_DIMENSION = 8192; // é™åˆ¶Canvasæœ€å¤§å°ºå¯¸é˜²å´©æºƒ

    // æ‹–æ‹½æ–‡ä»¶è¿›å…¥æµè§ˆå™¨äº‹ä»¶
    document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('dragOverlay').classList.add('active'); });
    document.addEventListener('dragleave', e => { if(e.relatedTarget === null) document.getElementById('dragOverlay').classList.remove('active'); });
    document.addEventListener('drop', e => {
        e.preventDefault();
        document.getElementById('dragOverlay').classList.remove('active');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        if(files.length > 0) handleFiles(files);
    });
    </script><script>
    function handleFiles(files) {
        if (!files.length) return;
        // ä¿®å¤ï¼šä½¿ç”¨ DocumentFragment ä¼˜åŒ–å¤§æ‰¹é‡å¯¼å…¥
        Array.from(files).forEach((file) => {
            imagesData.push({ url: URL.createObjectURL(file), name: file.name, size: file.size });
        });
        refreshGridHTML(); refreshUI(); calculateGroupBatch(); checkForDuplicates();
        document.getElementById('fileInput').value = '';
    }

    function refreshGridHTML() {
        const grid = document.getElementById('imageGrid');
        // ä¿æŒç©ºçŠ¶æ€ç»“æ„ï¼Œå¦‚æœä¸ºç©ºåˆ™éšè—
        grid.innerHTML = '<div id="emptyState" class="col-span-full py-8 text-center" style="display:none"><span class="text-gray-400">å¯¼å…¥å›¾ç‰‡</span></div>';
        
        const fragment = document.createDocumentFragment();
        // å¾ªç¯æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        imagesData.forEach((imgObj, i) => {
            const div = document.createElement('div');
            // ä¿®å¤ï¼šæ·»åŠ  CSS contain å±æ€§ä¼˜åŒ–ç™¾å¼ å›¾ç‰‡æ»‘åŠ¨æ€§èƒ½
            div.className = 'relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-100 thumbnail-item active:opacity-80 transition cursor-grab active:cursor-grabbing';
            div.style.contain = 'paint layout'; 
            div.innerHTML = `<img src="${imgObj.url}" class="w-full h-full object-cover pointer-events-none select-none" loading="lazy">`; 
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæ›¿æ¢æˆ–åˆ é™¤
            div.onmouseup = (e) => { openImageActions(i); };
            fragment.appendChild(div);
        });
        grid.appendChild(fragment);

        // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½æ’åº
        if(sortableInstance) sortableInstance.destroy();
        sortableInstance = new Sortable(grid, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            delay: 100, 
            delayOnTouchOnly: true,
            onEnd: function (evt) {
                // æ›´æ–°æ•°æ®æ•°ç»„é¡ºåº
                const item = imagesData.splice(evt.oldIndex, 1)[0];
                imagesData.splice(evt.newIndex, 0, item);
                refreshUI(); // ä»…åˆ·æ–°è®¡æ•°ï¼Œä¸å®Œå…¨é‡ç»˜Grid
            }
        });
    }
    </script><script>
    function openImageActions(index) { targetImageIndex = index; document.getElementById('imageActionOverlay').style.display = 'block'; setTimeout(() => document.getElementById('imageActionSheet').classList.add('show'), 10); }
    function closeImageActions() { document.getElementById('imageActionSheet').classList.remove('show'); setTimeout(() => document.getElementById('imageActionOverlay').style.display = 'none', 300); }
    
    function triggerReplace() { document.getElementById('replaceInput').click(); closeImageActions(); }
    function handleReplaceAction(files) { if(!files.length || targetImageIndex === -1) return; const file = files[0]; URL.revokeObjectURL(imagesData[targetImageIndex].url); imagesData[targetImageIndex] = { url: URL.createObjectURL(file), name: file.name, size: file.size }; refreshGridHTML(); checkForDuplicates(); document.getElementById('replaceInput').value = ''; }
    
    function triggerDelete() { if(confirm('ç¡®å®šåˆ é™¤?')) { URL.revokeObjectURL(imagesData[targetImageIndex].url); imagesData.splice(targetImageIndex, 1); refreshGridHTML(); refreshUI(); calculateGroupBatch(); checkForDuplicates(); } closeImageActions(); }
    
    function clearAll() { if(confirm('ç¡®å®šæ¸…ç©º?')) { imagesData.forEach(i => URL.revokeObjectURL(i.url)); imagesData=[]; refreshGridHTML(); refreshUI(); checkForDuplicates(); } }
    
    function refreshUI() { document.getElementById('countBadge').innerText = imagesData.length; document.getElementById('emptyState').style.display = imagesData.length ? 'none' : 'flex'; document.getElementById('clearBtn').style.display = imagesData.length ? 'block' : 'none'; updateStickerPreview(); }
    function handleStickerFile(files) { if(!files.length) return; const img = new Image(); img.onload = () => { stickerImg = img; updateStickerPreview(); }; img.src = URL.createObjectURL(files[0]); }
    
    function toggleCustomRatio() { document.getElementById('customRatioBox').style.display = (document.getElementById('aspectRatio').value === 'custom') ? 'flex' : 'none'; }
    function getCurrentRatio() {
        let ratio = parseFloat(document.getElementById('aspectRatio').value);
        if(isNaN(ratio) || document.getElementById('aspectRatio').value === 'custom') {
            const cw = parseInt(document.getElementById('customW').value) || 1000;
            const ch = parseInt(document.getElementById('customH').value) || 1500;
            ratio = cw / ch;
        }
        return ratio;
    }
    </script><script>
    function calculateGroupBatch() {
        const cols = parseInt(document.getElementById('cols').value) || 3;
        const rowsInput = document.getElementById('group_rows').value;
        const total = imagesData.length;
        const hint = document.getElementById('group_hint');
        const rows = rowsInput ? parseInt(rowsInput) : 50;
        
        if (cols > 0 && rows > 0) {
            const batchSize = cols * rows;
            const groups = total > 0 ? Math.ceil(total / batchSize) : 0;
            hint.innerHTML = `<span class="text-[#007AFF] font-bold">âœ… å·²å°±ç»ª:</span> <span>æ¯ç»„ <b>${batchSize}</b> å¼ ï¼Œå…± <b>${groups}</b> ç»„</span>`;
            hint.className = "mt-3 text-[11px] bg-[#007AFF]/5 text-[#007AFF] border border-[#007AFF]/20 p-2 rounded flex items-center gap-2";
        } else {
            hint.innerHTML = `<span class="font-bold">Waiting...</span><span>è¯·è®¾ç½®è¡Œå’Œåˆ—</span>`;
            hint.className = "mt-3 text-[11px] text-gray-500 bg-[#F2F2F7] p-2 rounded flex items-center gap-2";
        }
    }

    function applyQualityPreset(select) { const val = select.value; if (val === 'none') return; const input = document.getElementById('customQ_unified'); if (val === 'custom') input.focus(); else input.value = Math.round(parseFloat(val) * 100); }
    function validateQualityInput(el) { let val = parseInt(el.value); if (isNaN(val)) return; if (val > 100) el.value = 100; }
    
    async function previewQuality() {
        if (!imagesData.length) return alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€å¼ å›¾ç‰‡');
        showLoading(true, 'ç”Ÿæˆé¢„è§ˆ...');
        const modal = document.getElementById('previewModal'); const header = document.getElementById('previewHeader'); const imgEl = document.getElementById('qualityPreviewImg'); const canvasEl = document.getElementById('enlargedPreviewCanvas');
        canvasEl.classList.add('hidden'); imgEl.classList.remove('hidden'); header.classList.remove('hidden');
        let qVal = parseInt(document.getElementById('customQ_unified').value); if (isNaN(qVal) || qVal < 10) qVal = 10; if (qVal > 100) qVal = 100;
        header.innerText = `ç”»è´¨é¢„è§ˆ (å½“å‰: ${qVal}%)`;
        try {
            const imgObj = imagesData[0]; const img = new Image(); img.src = imgObj.url; await new Promise(r => img.onload = r);
            const cvs = document.createElement('canvas'); const scale = Math.min(1, 1000 / img.width); cvs.width = img.width * scale; cvs.height = img.height * scale;
            const ctx = cvs.getContext('2d'); ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
            imgEl.src = cvs.toDataURL((qVal === 100) ? 'image/png' : 'image/jpeg', (qVal === 100) ? undefined : qVal / 100); modal.style.display = 'flex';
        } catch(e) { console.error(e); alert('é¢„è§ˆå¤±è´¥'); }
        showLoading(false);
    }
    
    function syncOpacity(source) {
        const range = document.getElementById('overlayOpacityRange');
        const input = document.getElementById('overlayOpacityInput');
        if (source === 'range') input.value = range.value;
        else { let val = parseFloat(input.value); if (isNaN(val)) val = 1; if (val < 0) val = 0; if (val > 1) val = 1; range.value = val; }
    }

    function handleOverlayFile(files) {
        if (!files.length) return;
        const file = files[0]; const img = new Image();
        img.onload = () => { globalOverlayImg = img; document.getElementById('overlayInfoBox').classList.remove('hidden'); document.getElementById('overlayName').innerText = file.name; document.getElementById('overlayThumb').src = img.src; };
        img.src = URL.createObjectURL(file);
    }
    function clearOverlay() { globalOverlayImg = null; document.getElementById('overlayInput').value = ''; document.getElementById('overlayInfoBox').classList.add('hidden'); }
    </script><script>
    async function previewOverlayEffect() {
        if (!imagesData.length) return alert('è¯·å…ˆæ·»åŠ æ‹¼å›¾å›¾ç‰‡');
        if (!globalOverlayImg) return alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ è¦†ç›–å±‚å›¾ç‰‡');
        showLoading(true, 'ç”Ÿæˆé¢„è§ˆ...');
        try {
            // é¢„è§ˆåªå–å‰9å¼ 
            const cols = 3; const rows = 3; const batchSize = 9; 
            const firstBatchImgs = imagesData.slice(0, batchSize).map(d => d.url);
            // è¡¥é½9å¼ ä»¥ä¾¿é¢„è§ˆæ•ˆæœ
            while(firstBatchImgs.length < 9 && imagesData.length > 0) { firstBatchImgs.push(imagesData[0].url); }
            
            const previewCellW = 200; 
            const ratio = getCurrentRatio(); 
            const previewCellH = Math.floor(previewCellW / ratio);
            const gap = parseInt(document.getElementById('gap').value) || 0; 
            const previewGap = Math.max(0, Math.floor(gap / 5)); 
            
            const tempCanvas = document.createElement('canvas'); 
            const tempCtx = tempCanvas.getContext('2d');
            
            // è°ƒç”¨æ ¸å¿ƒç»˜å›¾å‡½æ•°ï¼ˆå¼ºåˆ¶æ— åºå·ï¼‰
            await drawAsync(tempCtx, firstBatchImgs, rows, cols, previewCellW, previewCellH, previewGap, 0, 1, [], false, true); 
            
            const modal = document.getElementById('previewModal'); 
            const header = document.getElementById('previewHeader'); 
            const imgEl = document.getElementById('qualityPreviewImg'); 
            const canvasEl = document.getElementById('enlargedPreviewCanvas');
            
            header.classList.remove('hidden'); 
            header.innerText = "æ•ˆæœé¢„è§ˆ (å¼ºåˆ¶3x3ï¼Œæ— åºå·)"; 
            canvasEl.classList.add('hidden'); 
            imgEl.classList.remove('hidden');
            
            tempCanvas.toBlob(blob => { 
                imgEl.src = URL.createObjectURL(blob); 
                modal.style.display = 'flex'; 
                showLoading(false); 
            }, 'image/jpeg', 0.8);
        } catch (e) { console.error(e); alert('é¢„è§ˆç”Ÿæˆå¤±è´¥'); showLoading(false); }
    }

    // è¿›åº¦æç¤º Toast è¾…åŠ©å‡½æ•°
    function showLoading(show, text) {
        const toast = document.getElementById('progressToast');
        const txt = document.getElementById('progressText');
        if (show) {
            toast.classList.remove('-translate-y-[200%]', 'opacity-0', 'pointer-events-none');
            if(text) txt.innerText = text;
        } else {
            toast.classList.add('-translate-y-[200%]', 'opacity-0', 'pointer-events-none');
        }
    }
    
    function cancelProcess() { isCancelled = true; showLoading(false); alert('å·²å–æ¶ˆç”Ÿæˆ'); }

    // å…³é”®ä¼˜åŒ–ï¼šç‚¹å‡»åå…ˆå¼¹çª—ï¼Œå¼ºåˆ¶ç­‰å¾…50mså†æ‰§è¡Œè®¡ç®—ï¼Œé˜²æ­¢ç•Œé¢å¡æ­»
    async function generate() { 
        isCancelled = false;
        showLoading(true, 'å‡†å¤‡å¼€å§‹...');
        await new Promise(r => setTimeout(r, 50)); 
        await runGeneration('normal'); 
    }
    
    async function generateMasked(type) { 
        isCancelled = false;
        showLoading(true, 'å¤„ç†ä¸­...');
        await new Promise(r => setTimeout(r, 50));
        await runGeneration(type); 
    }
    </script><script>
    async function runGeneration(opType) {
        if (!imagesData.length) { showLoading(false); return alert('è¯·æ·»åŠ å›¾ç‰‡'); }
        
        const container = document.getElementById('seamlessContainer'); 
        container.innerHTML = ''; 
        generatedBlobs = []; // æ¸…ç©ºæ—§æ•°æ®
        document.getElementById('realSizeContainer').classList.add('hidden');
        
        const startNum = parseInt(document.getElementById('startNumber').value) || 1;
        let targets = imagesData.map(d => d.url);
        
        // è§£ææ‰“ç ç›®æ ‡
        const rawInput = document.getElementById('maskIndices').value;
        let maskTargets = [];
        const parts = rawInput.split(/[,ï¼Œ\s]+/);
        parts.forEach(part => {
            part = part.trim(); if (!part) return;
            if (part.includes('-')) {
                const rangeParts = part.split('-');
                if (rangeParts.length === 2) { const s = parseInt(rangeParts[0]); const e = parseInt(rangeParts[1]); if (!isNaN(s) && !isNaN(e)) { for (let k = Math.min(s,e); k <= Math.max(s,e); k++) maskTargets.push(k); } }
            } else { const num = parseInt(part); if (!isNaN(num)) maskTargets.push(num); }
        });
        
        // å¦‚æœæ˜¯å‰”é™¤é‡æ’æ¨¡å¼
        if (opType === 'repack') {
            targets = targets.filter((_, i) => !maskTargets.includes(startNum + i));
        }

        const cols = parseInt(document.getElementById('cols').value) || 3;
        const rowsInput = document.getElementById('group_rows').value;
        const rows = rowsInput ? parseInt(rowsInput) : 50;
        const batchSize = cols * rows;
        
        // è·å–ç”»è´¨
        let qVal = parseInt(document.getElementById('customQ_unified').value); 
        if (isNaN(qVal) || qVal < 10) qVal = 10; 
        if (qVal > 100) qVal = 100;
        const isPng = (qVal === 100); 
        const mimeType = isPng ? 'image/png' : 'image/jpeg';
        
        const totalBatches = Math.ceil(targets.length / batchSize);
        const canvas = document.getElementById('canvas'); 
        const ctx = canvas.getContext('2d');
        const gap = parseInt(document.getElementById('gap').value) || 0; 

        try {
            for (let b = 0; b < totalBatches; b++) {
                if (isCancelled) break;
                showLoading(true, `æ­£åœ¨ç”Ÿæˆæ‹¼å›¾ ${b+1}/${totalBatches} ç»„...`);
                await new Promise(r => setTimeout(r, 20)); // è®©UIåˆ·æ–°
                
                const currentImgs = targets.slice(b*batchSize, Math.min((b+1)*batchSize, targets.length));
                const ratio = getCurrentRatio(); 
                
                // åŠ¨æ€è®¡ç®—å®½åº¦ï¼Œé˜²æ­¢çˆ†Canvaså†…å­˜
                let cellW = 1500; 
                if (cols * cellW > MAX_CANVAS_DIMENSION) {
                    cellW = Math.floor((MAX_CANVAS_DIMENSION - (cols*gap)) / cols);
                }
                let cellH = Math.floor(cellW / ratio);
                
                // æ‰§è¡Œç»˜å›¾
                await drawAsync(ctx, currentImgs, Math.ceil(currentImgs.length/cols), cols, cellW, cellH, gap, b*batchSize, startNum, maskTargets, opType === 'apply');
                
                if (isCancelled) break;
                
                // å¯¼å‡ºBlob
                await new Promise(res => canvas.toBlob(blob => {
                    if (isCancelled) { res(); return; }
                    generatedBlobs.push(blob);
                    
                    // åœ¨ç»“æœåŒºæ˜¾ç¤ºç¼©ç•¥å›¾
                    const img = document.createElement('img'); 
                    img.src = URL.createObjectURL(blob); 
                    // å…³é”®æ ·å¼ï¼šw-full block ç¡®ä¿å›¾ç‰‡æ’‘æ»¡å®¹å™¨å®½åº¦ï¼Œé«˜åº¦è‡ªé€‚åº”
                    img.className = "w-full block border-b border-gray-100 last:border-0"; 
                    container.appendChild(img); 
                    res();
                }, mimeType, isPng ? undefined : qVal / 100));
            }
            if (!isCancelled) { 
                document.getElementById('resultArea').classList.remove('hidden'); 
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                document.getElementById('resultArea').scrollIntoView({behavior:'smooth'}); 
                updateRealSizeDisplay(); 
            }
        } catch(e) { console.error(e); if(!isCancelled) alert('é”™è¯¯:'+e.message); }
        showLoading(false);
    }
    
    async function drawAsync(ctx, imgs, rows, cols, w, h, gap, globalOffset, startNum, maskIndices, applyMask, forceHideNums = false) {
        if (isCancelled) return;
        const canvas = ctx.canvas;
        canvas.width = cols * w + (cols-1) * gap; 
        canvas.height = rows * h + (rows-1) * gap;
        ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const showNum = document.getElementById('showNum').checked;
        const fontSize = parseInt(document.getElementById('fontSize').value) || 350;
        const fontPos = document.getElementById('fontPos').value;
        const fontFamily = document.getElementById('fontFamily').value; 
        const fontColor = document.getElementById('fontColor').value || '#FFFFFF';
        const shadowColor = document.getElementById('fontShadowColor').value || '#000000';
        const lineStyle = document.querySelector('input[name="lineStyle"]:checked') ? document.querySelector('input[name="lineStyle"]:checked').value : 'cross';

        for (let i = 0; i < imgs.length; i++) {
            if (isCancelled) return;
            // æé€Ÿä¼˜åŒ–ï¼šæ¯å¤„ç†30å¼ å›¾ç‰‡æš‚åœä¸€å¸§
            if (i % 30 === 0) await new Promise(r => setTimeout(r, 0)); 
            
            const r = Math.floor(i / cols); const c = i % cols;
            const x = c * (w + gap); 
            const y = r * (h + gap);
            
            const currentNum = startNum + globalOffset + i;
            const img = new Image(); img.src = imgs[i];
            
            await new Promise(resolve => { 
                if(img.complete) resolve(); 
                else { img.onload=resolve; img.onerror=resolve; } 
            });

            ctx.save(); ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
            const iRatio = img.width / img.height; const cRatio = w / h;
            if (iRatio > cRatio) {
                ctx.drawImage(img, x - (h*iRatio - w)/2, y, h*iRatio, h); 
            } else {
                ctx.drawImage(img, x, y - (w/iRatio - h)/2, w, w/iRatio);
            }
            ctx.restore();

            if (showNum && forceHideNums !== true) {
                ctx.save();
                ctx.shadowColor = shadowColor;
                ctx.shadowBlur = fontSize / 10;
                ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
                ctx.fillStyle = fontColor; 
                ctx.font = `bold ${fontSize}px ${fontFamily}`; 
                
                let tx = x + w/2, ty = y + h - fontSize/2;
                if(fontPos === 'center') ty = y + h/2 + fontSize/3; 
                else if(fontPos.includes('top')) ty = y + fontSize + 20;
                
                if(fontPos.includes('left')) { tx = x + 20; ctx.textAlign = 'left'; } 
                else if(fontPos.includes('right')) { tx = x + w - 20; ctx.textAlign = 'right'; } 
                else ctx.textAlign = 'center';
                
                ctx.fillText(currentNum, tx, ty);
                ctx.restore(); 
            }
            
            if (applyMask && maskIndices.includes(currentNum)) {
                if (currentMaskMode === 'line') {
                    ctx.beginPath(); 
                    ctx.strokeStyle = document.getElementById('maskColor').value; 
                    ctx.lineWidth = document.getElementById('maskWidth').value * (w/500) * 5; 
                    ctx.lineCap = 'round';
                    if (lineStyle === 'cross') { 
                        ctx.moveTo(x+w*0.2, y+h*0.2); ctx.lineTo(x+w*0.8, y+h*0.8); 
                        ctx.moveTo(x+w*0.8, y+h*0.2); ctx.lineTo(x+w*0.2, y+h*0.8); 
                    } else { 
                        ctx.moveTo(x+w*0.2, y+h*0.8); ctx.lineTo(x+w*0.8, y+h*0.2); 
                    }
                    ctx.stroke();
                } else if (currentMaskMode === 'image' && stickerImg) {
                    const sizePct = document.getElementById('stickerSize').value / 100; 
                    const xPct = document.getElementById('stickerX').value / 100; 
                    const yPct = document.getElementById('stickerY').value / 100;
                    const sw = w * sizePct; 
                    const sh = sw * (stickerImg.height / stickerImg.width);
                    ctx.drawImage(stickerImg, x + (w * xPct) - sw/2, y + (h * yPct) - sh/2, sw, sh);
                }
            }
        }
        
        if (globalOverlayImg) { 
            ctx.save(); 
            ctx.globalAlpha = parseFloat(document.getElementById('overlayOpacityInput').value); 
            ctx.globalCompositeOperation = document.getElementById('overlayMode').value; 
            ctx.drawImage(globalOverlayImg, 0, 0, canvas.width, canvas.height); 
            ctx.restore(); 
        }
    }
    </script>
    <script>
    function updateRealSizeDisplay() {
        if (!generatedBlobs.length) return;
        const container = document.getElementById('realSizeContainer'); 
        const totalText = document.getElementById('realTotalSize');
        const detailBox = document.getElementById('groupSizeDetail'); 
        const toggleBtn = document.getElementById('btnToggleSizes');
        const combinedTip = document.getElementById('combinedSizeTip'); 
        const combinedVal = document.getElementById('combinedSizeValue');
        
        let totalBytes = 0; 
        detailBox.innerHTML = '';
        generatedBlobs.forEach((blob, index) => {
            totalBytes += blob.size;
            const item = document.createElement('div'); item.className = "px-2";
            item.innerHTML = `<span class="opacity-70">åˆ†ç»„ ${index + 1}:</span> <span class="font-bold">${(blob.size / 1024 / 1024).toFixed(2)} MB</span>`;
            detailBox.appendChild(item);
        });
        
        const totalMB = (totalBytes / 1024 / 1024).toFixed(2); 
        totalText.innerText = `åˆ†å·æ€»è®¡: ${totalMB} MB`;
        
        // è¶…è¿‡100å¼ ä¸å»ºè®®åˆå¹¶
        if (imagesData.length <= 100) { 
            combinedTip.classList.remove('hidden'); 
            combinedVal.innerText = `${totalMB} MB`; 
        } else { 
            combinedTip.classList.add('hidden'); 
        }
        
        container.classList.remove('hidden');
        if (generatedBlobs.length <= 1) { 
            toggleBtn.classList.add('hidden'); detailBox.classList.add('hidden'); 
        } else { 
            toggleBtn.classList.remove('hidden'); detailBox.classList.add('hidden'); 
            toggleBtn.innerText = `å±•å¼€ ${generatedBlobs.length} ä¸ªåˆ†ç»„è¯¦æƒ… â–¼`; 
        }
    }

    function toggleGroupSizes() { 
        const detailBox = document.getElementById('groupSizeDetail'); 
        const btn = document.getElementById('btnToggleSizes'); 
        if (detailBox.classList.contains('hidden')) { 
            detailBox.classList.remove('hidden'); btn.innerText = 'æ”¶èµ·è¯¦æƒ… â–²'; 
        } else { 
            detailBox.classList.add('hidden'); btn.innerText = `å±•å¼€ ${generatedBlobs.length} ä¸ªåˆ†ç»„è¯¦æƒ… â–¼`; 
        } 
    }
    
    function confirmDownload(type) { 
        if (!generatedBlobs.length) return alert('è¯·å…ˆç”Ÿæˆæ‹¼å›¾'); 
        const totalBytes = generatedBlobs.reduce((acc, b) => acc + b.size, 0); 
        const msg = `å½“å‰æ–‡ä»¶æ€»å¤§å°ä¸ºï¼š${(totalBytes / 1024 / 1024).toFixed(2)} MB\n\nç¡®è®¤å¼€å§‹ä¸‹è½½å—ï¼Ÿ`; 
        if (confirm(msg)) { 
            if (type === 'zip') downloadZip(); 
            else if (type === 'combine') combineAndDownload(); 
            else if (type === 'parts') downloadAllParts(); 
        } 
    }
    </script><script>
    function downloadZip() {
        showLoading(true, 'æ­£åœ¨æ‰“åŒ… ZIP...');
        const zip = new JSZip(); 
        const folder = zip.folder("æ‹¼å›¾åˆ†ç»„");
        let qVal = parseInt(document.getElementById('customQ_unified').value); 
        if (isNaN(qVal) || qVal < 10) qVal = 10;
        const ext = (qVal === 100) ? 'png' : 'jpg';
        
        generatedBlobs.forEach((blob, i) => { folder.file(`æ‹¼å›¾_Part_${i+1}.${ext}`, blob); });
        
        zip.generateAsync({type:"blob"}).then(function(content) { 
            if(isCancelled) return; 
            downloadBlob(content, `æ‹¼å›¾æ‰“åŒ…_${new Date().getTime()}.zip`); 
            showLoading(false); 
        }).catch(function(e) { 
            if(!isCancelled) alert('æ‰“åŒ…å¤±è´¥: ' + e.message); 
            showLoading(false); 
        });
    }
    
    async function combineAndDownload() {
        if (imagesData.length > 100) return alert('âš ï¸ å›¾ç‰‡æ•°é‡è¶…è¿‡100å¼ ï¼Œç¦æ­¢åˆå¹¶å¯¼å‡ºã€‚\n\nè¯·ä½¿ç”¨ "æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ†ç»„ (ZIP)"ã€‚');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let qVal = parseInt(document.getElementById('customQ_unified').value); 
        if (isNaN(qVal) || qVal < 10) qVal = 10; if (qVal > 100) qVal = 100;
        const isPng = (qVal === 100); const ext = isPng ? 'png' : 'jpg';
        
        if (generatedBlobs.length === 1) { downloadBlob(generatedBlobs[0], `æ‹¼å›¾_å®Œæ•´ç‰ˆ.${ext}`); return; }
        
        showLoading(true, 'æ­£åœ¨åˆå¹¶...');
        try {
            const bitmaps = await Promise.all(generatedBlobs.map(b => createImageBitmap(b)));
            const totalH = bitmaps.reduce((sum, bmp) => sum + bmp.height, 0); const maxW = bitmaps[0].width;
            
            // iOS Safari Canvas åƒç´ é™åˆ¶ä¿æŠ¤
            if (maxW * totalH > (isMobile ? 16777216 : 50000000)) { 
                showLoading(false); 
                return alert('å›¾ç‰‡æ€»åƒç´ è¿‡å¤§ï¼Œæ‰‹æœºæµè§ˆå™¨æ— æ³•å¤„ç†ã€‚\nè¯·ä½¿ç”¨ "æ‰“åŒ…ä¸‹è½½ (ZIP)"ã€‚'); 
            }
            
            const canvas = document.createElement('canvas'); 
            canvas.width = maxW; canvas.height = totalH; 
            const ctx = canvas.getContext('2d'); 
            let y = 0;
            
            for(let bmp of bitmaps) { 
                if (isCancelled) break; 
                ctx.drawImage(bmp, 0, y); 
                y += bmp.height; 
            }
            
            if(!isCancelled) { 
                canvas.toBlob(blob => { 
                    if (isCancelled) return; 
                    downloadBlob(blob, `æ‹¼å›¾_åˆå¹¶ç‰ˆ_${new Date().getTime()}.${ext}`); 
                    showLoading(false); 
                }, isPng ? 'image/png' : 'image/jpeg', isPng ? undefined : qVal/100); 
            }
        } catch(e) { if(!isCancelled) alert('åˆå¹¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ZIPæ‰“åŒ…ã€‚'); showLoading(false); }
    }
    
    function downloadAllParts() { 
        generatedBlobs.forEach((blob, i) => { 
            setTimeout(() => { 
                const ext = blob.type.includes('png') ? 'png' : 'jpg'; 
                downloadBlob(blob, `æ‹¼å›¾_Part_${i+1}.${ext}`); 
            }, i * 300); 
        }); 
    }
    function downloadBlob(blob, name) { 
        const link = document.createElement('a'); link.download = name; link.href = URL.createObjectURL(blob); link.click(); setTimeout(() => URL.revokeObjectURL(link.href), 1000); 
    }
    </script><script>
    // è‡ªåŠ¨ä¿å­˜ä¸è´´çº¸é¢„è§ˆé€»è¾‘
    function switchMaskTab(mode) {
        currentMaskMode = mode;
        const lineTab = document.getElementById('tab-line'); const imgTab = document.getElementById('tab-image');
        lineTab.className = mode==='line' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        imgTab.className = mode==='image' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        document.getElementById('mask-panel-line').style.display = mode==='line' ? 'block' : 'none'; document.getElementById('mask-panel-image').style.display = mode==='image' ? 'block' : 'none';
        if(mode === 'image') updateStickerPreview();
    }
    
    function updateStickerPreview() {
        const canvas = document.getElementById('stickerPreviewCanvas'); const ctx = canvas.getContext('2d'); const w = canvas.width = 300; const h = canvas.height = 300; ctx.clearRect(0,0,w,h);
        if (imagesData.length > 0) { const bgImg = new Image(); bgImg.src = imagesData[0].url; if(bgImg.complete) drawPreviewContent(ctx, w, h, bgImg); else bgImg.onload = () => drawPreviewContent(ctx, w, h, bgImg); } else { ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0,0,w,h); ctx.fillStyle = '#ccc'; ctx.textAlign = 'center'; ctx.fillText('æ— å›¾', w/2, h/2); }
    }
    
    function drawPreviewContent(ctx, w, h, bgImg) {
        const sRatio = bgImg.width / bgImg.height; const cRatio = w / h;
        if(sRatio > cRatio) ctx.drawImage(bgImg, (bgImg.width - bgImg.height*cRatio)/2, 0, bgImg.height*cRatio, bgImg.height, 0, 0, w, h); else ctx.drawImage(bgImg, 0, (bgImg.height - bgImg.width/cRatio)/2, bgImg.width, bgImg.width/cRatio, 0, 0, w, h);
        if (stickerImg) { const sizePct = document.getElementById('stickerSize').value / 100; const xPct = document.getElementById('stickerX').value / 100; const yPct = document.getElementById('stickerY').value / 100; const sw = w * sizePct; const sh = sw * (stickerImg.height / stickerImg.width); ctx.drawImage(stickerImg, (w * xPct) - sw/2, (h * yPct) - sh/2, sw, sh); }
    }
    
    function enlargeStickerPreview() {
        const modal = document.getElementById('previewModal'); const header = document.getElementById('previewHeader'); const canvasEl = document.getElementById('enlargedPreviewCanvas'); const imgEl = document.getElementById('qualityPreviewImg');
        header.classList.add('hidden'); imgEl.classList.add('hidden'); canvasEl.classList.remove('hidden');
        const ratio = getCurrentRatio(); const baseW = 600; const baseH = baseW / ratio; canvasEl.width = baseW; canvasEl.height = baseH; const ctx = canvasEl.getContext('2d');
        if (imagesData.length > 0) { const bgImg = new Image(); bgImg.src = imagesData[0].url; bgImg.onload = () => { drawPreviewContent(ctx, baseW, baseH, bgImg); modal.style.display = 'flex'; } } else { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,baseW,baseH); modal.style.display = 'flex'; }
    }

    // è®¾ç½®ä¿å­˜
    const SETTINGS_KEY = 'puzzleSettings_Ultimate_V3';
    function saveSettings() {
        const settings = { 
            cols: document.getElementById('cols').value, 
            aspectRatio: document.getElementById('aspectRatio').value, 
            customW: document.getElementById('customW').value, 
            customH: document.getElementById('customH').value, 
            showNum: document.getElementById('showNum').checked, 
            startNumber: document.getElementById('startNumber').value, 
            fontSize: document.getElementById('fontSize').value, 
            fontPos: document.getElementById('fontPos').value, 
            fontFamily: document.getElementById('fontFamily').value,
            fontColor: document.getElementById('fontColor').value,
            fontShadowColor: document.getElementById('fontShadowColor').value,
            gap: document.getElementById('gap').value,
            group_rows: document.getElementById('group_rows').value, 
            customQ_unified: document.getElementById('customQ_unified').value 
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY); if (!saved) return;
        try {
            const s = JSON.parse(saved);
            if(s.cols) document.getElementById('cols').value = s.cols;
            if(s.aspectRatio) { document.getElementById('aspectRatio').value = s.aspectRatio; toggleCustomRatio(); }
            if(s.customW) document.getElementById('customW').value = s.customW; 
            if(s.customH) document.getElementById('customH').value = s.customH; 
            if(s.showNum !== undefined) document.getElementById('showNum').checked = s.showNum; 
            if(s.startNumber) document.getElementById('startNumber').value = s.startNumber; 
            if(s.fontSize) document.getElementById('fontSize').value = s.fontSize; 
            if(s.fontPos) document.getElementById('fontPos').value = s.fontPos; 
            if(s.fontFamily) document.getElementById('fontFamily').value = s.fontFamily;
            if(s.fontColor) document.getElementById('fontColor').value = s.fontColor;
            if(s.fontShadowColor) document.getElementById('fontShadowColor').value = s.fontShadowColor;
            if(s.gap) { document.getElementById('gap').value = s.gap; document.getElementById('gapValueDisplay').innerText = s.gap + 'px'; }
            if(s.group_rows) document.getElementById('group_rows').value = s.group_rows; 
            if(s.customQ_unified) document.getElementById('customQ_unified').value = s.customQ_unified;
            calculateGroupBatch(); 
        } catch(e) { console.error('è¯»å–è®¾ç½®å¤±è´¥', e); }
    }
    
    // æŸ¥é‡åŠŸèƒ½
    function checkForDuplicates() {
        const names = imagesData.map(i => i.name + i.size);
        const uniqueNames = new Set(names);
        const diff = names.length - uniqueNames.size;
        const alertBox = document.getElementById('duplicateAlert');
        if (diff > 0) {
            alertBox.classList.remove('hidden');
            document.getElementById('dupCount').innerText = diff;
        } else {
            alertBox.classList.add('hidden');
        }
    }
    
    function removeDuplicates() {
        const seen = new Set();
        imagesData = imagesData.filter(item => {
            const key = item.name + item.size;
            const duplicate = seen.has(key);
            seen.add(key);
            if(duplicate) URL.revokeObjectURL(item.url);
            return !duplicate;
        });
        refreshGridHTML(); refreshUI(); calculateGroupBatch(); checkForDuplicates();
    }

    function hardReset() { const modal = document.getElementById('resetAlert'); const backdrop = document.getElementById('resetBackdrop'); const content = document.getElementById('resetModal'); modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('opacity-0', 'scale-110'); content.classList.remove('scale-100'); content.classList.add('scale-100'); }, 10); }
    function closeResetAlert() { const modal = document.getElementById('resetAlert'); const backdrop = document.getElementById('resetBackdrop'); const content = document.getElementById('resetModal'); backdrop.classList.add('opacity-0'); content.classList.add('opacity-0', 'scale-110'); content.classList.remove('scale-100'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200); }
    function confirmResetAction() { localStorage.removeItem(SETTINGS_KEY); location.reload(); }
    
    function initNotesCheck() { const isHidden = localStorage.getItem('puzzle_hide_notes_v1'); if (!isHidden) { const btn = document.getElementById('noteFloatBtn'); if(btn) btn.classList.remove('hidden'); } }
    function showNotes() { const modal = document.getElementById('noteModal'); modal.style.display = 'flex'; const content = modal.querySelector('div'); content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }
    function closeNotes() { document.getElementById('noteModal').style.display = 'none'; }
    function permanentCloseNotes() { 
        if(confirm('ç¡®å®šä¸å†æ˜¾ç¤ºæ­¤æ‚¬æµ®çƒå—ï¼Ÿ\n(æ‚¨å¯ä»¥é€šè¿‡æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æ¥æ¢å¤)')) { 
            localStorage.setItem('puzzle_hide_notes_v1', 'true'); 
            closeNotes(); 
            document.getElementById('noteFloatBtn').classList.add('hidden'); 
        } 
    }

    window.addEventListener('beforeunload', function (e) { if (imagesData.length > 0) { e.preventDefault(); e.returnValue = 'ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ'; return 'ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ'; } });
    window.addEventListener('DOMContentLoaded', () => { loadSettings(); initNotesCheck(); const inputs = document.querySelectorAll('input, select'); inputs.forEach(input => { if(input.type !== 'file') { input.addEventListener('change', saveSettings); input.addEventListener('input', saveSettings); } }); });
</script>

<div id="noteFloatBtn" class="fixed right-5 bottom-28 z-40 hidden transition-all duration-300 hover:scale-105">
    <button onclick="showNotes()" class="bg-white/90 backdrop-blur-md text-[#007AFF] shadow-[0_4px_12px_rgba(0,0,0,0.15)] border border-white/50 font-bold text-[13px] px-4 py-2.5 rounded-full flex items-center gap-1.5 active:scale-95 transition">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>æ³¨æ„äº‹é¡¹</span>
    </button>
</div>
<div id="noteModal" class="modal-overlay" onclick="closeNotes()">
    <div class="bg-white w-[85%] max-w-[320px] rounded-2xl p-6 relative shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
        <div class="flex items-center gap-2 mb-4">
        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-[#007AFF]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-[18px] font-bold text-gray-900">ä½¿ç”¨é¡»çŸ¥</h3>
        </div>
        <div class="text-[14px] text-gray-600 leading-relaxed mb-6 space-y-3 max-h-[50vh] overflow-y-auto pr-1">
            <p>1. å»ºè®®ä½¿ç”¨ <b>edg</b> æµè§ˆå™¨ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</p>
            <p>2.edgå¯ä»¥æ·»åŠ åˆ°æ‰‹æœºä¸»å±å¹•ä¸Šä½¿ç”¨ã€‚</p>
            <p>3. å¦‚æœå›¾ç‰‡è¶…è¿‡ 100 å¼ ï¼Œç”Ÿæˆè¿‡ç¨‹å¯èƒ½ä¼šæœ‰çŸ­æš‚å¡é¡¿ã€‚ç”šè‡³ç¬¬ä¸€ç»„æ‹¼å›¾æ˜¯å…¨é»‘è‰²ï¼Œå¦‚æœé‡åˆ°é‡æ–°æ‹¼å›¾ã€‚</p>
            <p>4. å¤šç»„å›¾ç‰‡å¯¼å‡ºï¼Œå—æµè§ˆå™¨å½±å“ï¼Œå¯èƒ½ä¸ä¼šå…¨éƒ¨ä¸‹è½½å®Œå›¾ç‰‡ã€‚è¯·å°è¯•ä½¿ç”¨â€œæ‰“åŒ…ä¸‹è½½(ZIP)â€åŠŸèƒ½ã€‚</p>
            <p>5. â—ï¸â—ï¸â—ï¸å¤šå›¾ä¸€å®šè¦è°ƒä¸€ä¸‹ç”»è´¨ï¼Œä¸ç„¶å›¾ç‰‡å¤ªå¤§äº†â—ï¸è°ƒ30%ä¹Ÿä¸å½±å“çœ‹å›¾â—ï¸â—ï¸â—ï¸</p>
	            <p>6. æœ‰æ—¶é—´è€å¸ˆä»¬å¯ä»¥æ‰¾å¹³æ›¿çš„ï¼Œä¸€äº›åŸå› æœ‰ç‚¹æƒ³åˆ é“¾æ¥äº†ï¼Œï¼Œï¼Œâ‚Ë„Â·Íˆà¼Â·ÍˆË„â‚â— Ì‘Ì‘</p>
            <p>7. â—ï¸è¶…è¿‡ä¸€ç™¾å¼ å›¾ä¸ä¼šåˆå¹¶ç”Ÿæˆä¸€å¼ æ‹¼å›¾ï¼Œ è¯·è‡ªè¡Œå¡«å†™è¡Œåˆ—ï¼Œåˆ†å¤šå¼ å›¾å¯¼å‡ºâ—ï¸</p>
        </div>
        <div class="flex items-center gap-3 mt-2">
            <button onclick="permanentCloseNotes()" class="text-xs text-gray-400 font-medium py-2 px-2 active:text-gray-600 transition">ä¸å†æ˜¾ç¤º</button>
            <button onclick="closeNotes()" class="flex-1 bg-[#007AFF] text-white text-[15px] font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div><div id="updateNoticeModal" class="modal-overlay" style="z-index: 200;">
    <div class="bg-white w-[85%] max-w-[320px] rounded-2xl p-6 relative shadow-2xl transform transition-all scale-100 animate-fade-in" onclick="event.stopPropagation()">
        
        <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center text-[#34C759]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
            </div>
            <h3 class="text-[18px] font-bold text-gray-900">æ›´æ–°äº†ä¸€ä¸‹</h3>
        </div>

        <div class="text-[14px] text-gray-600 leading-relaxed mb-6 space-y-2 max-h-[50vh] overflow-y-auto pr-1">
            <p class="font-bold text-black">âœ¨ </p>
            <ul class="list-disc pl-4 space-y-1">
                <li>æ·»åŠ äº†å¯ä»¥åœ¨edgæµè§ˆå™¨å®‰è£…åˆ°å±å¹•çš„ï¼Œåœ¨edgæµè§ˆå™¨çš„æ·»åŠ åˆ°æ‰‹æœºå¤„æ·»åŠ </li>
                <li>ä¼˜åŒ–äº†ä¸€ä¸‹ç•Œé¢ï¼Œæ·»åŠ äº†å›¾ç‰‡é—´éš™ï¼Œä¿å­˜æ¯ä¸€æ¬¡æ•°å€¼è®¾ç½®
ï¼ˆè§‰å¾—è€å¸ˆä»¬æœ‰æ—¶é—´å¯ä»¥æ‰¾ä¸ªå¹³æ›¿çš„ï¼Œä¸€äº›åŸå› æœ‰ç‚¹æƒ³åˆ é“¾æ¥äº†â‚Ë„Â·Íˆà¼Â·ÍˆË„â‚â— Ì‘Ì‘ï¼Œï¼Œï¼Œï¼‰</li>
<li>æœ€æ–°ç‰ˆé“¾æ¥:https://x9353953-source.github.io/ikko/<li>
               
                
            </ul>
        </div>

        <div class="flex items-center gap-3 mt-2">
            <button onclick="dontShowUpdateAgain()" class="text-xs text-gray-400 font-medium py-2 px-2 active:text-gray-600 transition">ä¸å†æç¤º</button>
            <button onclick="closeUpdateModal()" class="flex-1 bg-[#34C759] text-white text-[15px] font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 active:scale-95 transition">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<script>
    // å®šä¹‰ç‰ˆæœ¬å·ï¼Œå¦‚æœä¸‹æ¬¡è¿˜æœ‰æ›´æ–°æƒ³å†æ¬¡å¼¹å‡ºï¼Œåªéœ€ä¿®æ”¹è¿™ä¸ªå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚æ”¹æˆ 'update_notice_v2'ï¼‰
    const UPDATE_KEY = 'puzzle_update_notice_v1';

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
    window.addEventListener('load', () => {
        const hasRead = localStorage.getItem(UPDATE_KEY);
        // å¦‚æœæ²¡æœ‰è®°å½•ï¼ˆè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡æˆ–è€…æ˜¯æ¸…ç©ºç¼“å­˜åï¼‰ï¼Œåˆ™æ˜¾ç¤ºå¼¹çª—
        if (!hasRead) {
            setTimeout(() => {
                const modal = document.getElementById('updateNoticeModal');
                modal.style.display = 'flex';
            }, 500); // å»¶è¿Ÿ0.5ç§’å¼¹å‡ºï¼Œä½“éªŒæ›´å¥½
        }
    });

    // å…³é—­å¼¹çª—ï¼ˆä»…æœ¬æ¬¡å…³é—­ï¼‰
    function closeUpdateModal() {
        const modal = document.getElementById('updateNoticeModal');
        modal.style.display = 'none';
    }

    // ä¸å†æç¤ºï¼ˆæ°¸ä¹…å…³é—­ï¼Œç›´åˆ°ä½ ä¿®æ”¹ç‰ˆæœ¬å·ï¼‰
    function dontShowUpdateAgain() {
        localStorage.setItem(UPDATE_KEY, 'true');
        closeUpdateModal();
    }
</script>
</body>
</html>