<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾Ultimate (ikko)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            color: #000000;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 200px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* iOSé£æ ¼å¡ç‰‡å®¹å™¨ */
        .ios-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }/* åˆ—è¡¨é¡¹åˆ†å‰²çº¿ */
        .ios-divide > div:not(:last-child), 
        .ios-divide > label:not(:last-child) { border-bottom: 0.5px solid #C6C6C8; }
        
        input[type=number], select, input[type=text] { appearance: none; -webkit-appearance: none; background: transparent; }
        
        /* æ»‘åŠ¨æ¡æ ·å¼ */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 24px; margin: 0; padding: 0; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #E5E5EA; border-radius: 2px; border: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; background: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: 0.5px solid rgba(0,0,0,0.04); margin-top: -9px; transition: transform 0.1s; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }

        /* æ¨¡æ€æ¡†ä¸åŠ¨ç”» */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .checkered-bg { background-color: #eee; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
        .action-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #F2F2F7; border-top-left-radius: 16px; border-top-right-radius: 16px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 101; padding: 20px; padding-bottom: 40px; }
        .action-sheet.show { transform: translateY(0); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head><body class="antialiased"><header class="sticky top-0 z-50 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-gray-200/50 supports-[backdrop-filter]:bg-[#F2F2F7]/60">
        <div class="max-w-2xl mx-auto px-5 py-3 flex justify-between items-center h-[52px]">
            <h1 class="text-[22px] font-bold tracking-tight text-black">æ‹¼å›¾æ’åº<span class="text-xs font-normal text-white bg-black px-1.5 py-0.5 rounded ml-1">Ultimate</span></h1>
            <button onclick="document.getElementById('fileInput').click()" class="bg-white text-[#007AFF] text-[15px] font-bold px-4 py-1.5 rounded-full shadow-sm active:bg-gray-100 transition flex items-center gap-1">
                <svg class="w-4 h-4 stroke-[3px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                æ·»åŠ 
            </button>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
            <input type="file" id="replaceInput" accept="image/*" class="hidden" onchange="handleReplaceAction(this.files)">
            <input type="file" id="stickerInput" accept="image/*" class="hidden" onchange="handleStickerFile(this.files)">
        </div>
    </header>        <main class="max-w-2xl mx-auto px-4 pt-4 relative"><div id="progressToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) -translate-y-[200%] opacity-0 pointer-events-none">
            <div class="bg-white/90 backdrop-blur-xl text-gray-900 rounded-full shadow-lg flex items-center py-3 pl-5 pr-2 gap-3 border border-gray-200/50 min-w-[240px] max-w-[90vw]">
                
                <div class="flex-1 flex flex-col justify-center min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <span id="progressText" class="text-[15px] font-bold leading-tight truncate">å‡†å¤‡ä¸­...</span>
                        <span id="progressDetail" class="text-[12px] text-gray-500 font-mono ml-3">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-[#007AFF] h-full w-0 transition-all duration-300 ease-out"></div>
                    </div>
                </div>

                <button onclick="cancelProcess()" class="pointer-events-auto w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 active:scale-90 transition text-gray-500 hover:text-gray-900 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div><div class="ios-card p-4">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[13px] text-gray-500 uppercase font-medium pl-1">å·²å¯¼å…¥ <span id="countBadge">0</span> å¼ </span>
                <button onclick="clearAll()" class="text-[#FF3B30] text-[13px] active:opacity-50 transition hidden" id="clearBtn">æ¸…ç©º</button>
            </div>
            <div id="imageGrid" class="grid grid-cols-4 gap-2 overflow-y-auto max-h-[280px] min-h-[100px] no-scrollbar">
                <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-8 space-y-3">
                    <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <span class="text-gray-400 text-sm">å¯¼å…¥å›¾ç‰‡ (ç‚¹å‡»å›¾ç‰‡å¯æ›¿æ¢/åˆ é™¤)</span>
                </div>
            </div>
        </div>

<div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">å¸ƒå±€è®¾ç½®</div>
        <div class="ios-card ios-divide">
            <div class="p-4 bg-white active:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <span class="text-[17px]">åˆ—æ•° (æ¨ªå‘)</span>
                    <div class="flex items-center bg-[#767680]/10 rounded-md px-3 py-1.5">
                        <input type="number" id="cols" value="3" class="w-12 text-center text-[17px] font-medium focus:outline-none">
                        <span class="text-gray-500 text-xs ml-1">åˆ—</span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-400 mt-2 leading-tight">
                    * è®¾ç½®æ¨ªå‘æ’åˆ—å‡ å¼ å›¾ï¼Œè¡Œæ•°ä¼šè‡ªåŠ¨è®¡ç®—ã€‚<br>
                    * ä¾‹å¦‚ï¼š100å¼ å›¾è®¾ä¸º4åˆ—ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ25è¡Œã€‚
                    
                   ï¼ˆå…¶å®å¯ä»¥å¿½ç•¥è¿™ä¸ªï¼Œåœ¨å¯¼å‡ºä¸åˆ†ç»„é‚£è®¾ç½®åˆ—å°±å¥½äº†ï¼‰
                </div>
            </div>

            <input type="hidden" id="gap" value="0"><div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition relative">
                <span class="text-[17px]">ç”»å¸ƒæ¯”ä¾‹</span>
                <div class="flex items-center gap-2">
                    <select id="aspectRatio" onchange="toggleCustomRatio()" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none text-right appearance-none cursor-pointer dir-rtl">
                        <option value="0.5625">9:16 æ‰‹æœºå…¨å±</option>
                        <option value="0.75">3:4 æµ·æŠ¥</option>
                        <option value="1">1:1 æ­£æ–¹å½¢</option>
                        <option value="1.333">4:3 ç…§ç‰‡</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
            </div>
            <div id="customRatioBox" class="hidden p-4 bg-gray-50 flex items-center justify-end gap-3 border-t border-gray-100">
                <input type="number" id="customW" placeholder="å®½" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1000">
                <span class="text-gray-400">:</span>
                <input type="number" id="customH" placeholder="é«˜" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1500">
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">åºå·æ ‡æ³¨</div>
        <div class="ios-card ios-divide">
            <div class="flex items-center justify-between p-4 bg-white">
                <span class="text-[17px]">æ˜¾ç¤ºåºå·</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="showNum" checked class="sr-only peer">
                    <div class="w-[51px] h-[31px] bg-[#E9E9EA] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-[27px] after:w-[27px] after:shadow-sm after:transition-all peer-checked:bg-[#34C759]"></div>
                </label>
            </div><div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">èµ·å§‹æ•°å€¼</span>
                <input type="number" id="startNumber" value="1" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20 bg-gray-50 rounded px-2 py-1" placeholder="1">
            </div>
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">å­—å·å¤§å°</span>
                <input type="number" id="fontSize" value="350" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20" placeholder="150">
            </div>
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">ä½ç½®</span>
                <select id="fontPos" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl">
                    <option value="bottom-center">åº•éƒ¨å±…ä¸­</option>
                    <option value="bottom-left">åº•éƒ¨å·¦ä¾§</option>
                    <option value="bottom-right">åº•éƒ¨å³ä¾§</option>
                    <option value="center">æ­£ä¸­é—´</option>
                    <option value="top-left">å·¦ä¸Šè§’</option>
                    <option value="top-right">å³ä¸Šè§’</option>
                </select>
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium mt-6">å¯¼å‡ºä¸åˆ†ç»„ç­–ç•¥</div>
        <div class="px-1 mb-3">
            <div class="bg-[#767680]/15 p-1 rounded-lg flex relative">
                <div id="mode-indicator" class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-md shadow-sm transition-all duration-300"></div>
                <button onclick="switchMode('small')" id="btn-small" class="flex-1 relative z-10 text-[13px] font-medium py-1.5 text-center transition-colors">100å¼ ä»¥ä¸‹ (åˆ†ç»„)</button>
                <button onclick="switchMode('large')" id="btn-large" class="flex-1 relative z-10 text-[13px] font-medium py-1.5 text-center transition-colors text-gray-500">100å¼ ä»¥ä¸Š (åå°)</button>
            </div>
        </div><div id="group-panel-small" class="ios-card ios-divide mb-6">
             <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[17px] font-bold">è‡ªå®šä¹‰åˆ†ç»„å¯¼å‡º</span>
                    <span class="text-xs text-[#007AFF] font-medium bg-[#007AFF]/10 px-2 py-0.5 rounded">æ’åºä¼˜å…ˆ</span>
                </div>
                <div class="text-[11px] text-gray-400 leading-tight mb-4">
                    * é€‚ç”¨äºå°‘äº100å¼ çš„ç²¾ç»†åŒ–åˆ†ç»„ã€‚
                    * å›¾ç‰‡å°†æŒ‰ä¸Šæ–¹è®¾ç½®çš„â€œåˆ—æ•°â€æ’åºï¼Œç„¶åæŒ‰ä¸‹æ–¹è®¾ç½®è¢«åˆ‡åˆ†ä¸ºå¤šç»„å¯¼å‡ºã€‚
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                         <label class="text-[11px] text-gray-500 block mb-1">æ¯ç»„åˆ—æ•°</label>
                         <input type="number" id="small_cols" placeholder="å¦‚: 3" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="calculateSmallBatch()">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                         <label class="text-[11px] text-gray-500 block mb-1">æ¯ç»„è¡Œæ•°</label>
                         <input type="number" id="small_rows" placeholder="å¦‚: 5" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="calculateSmallBatch()">
                    </div>
                </div>

                <div class="mt-3 text-[11px] text-gray-500 bg-[#F2F2F7] p-2 rounded flex items-center gap-2" id="small_hint">
                    <span class="font-bold">Waiting...</span>
                    <span>è¯·è®¾ç½®è¡Œå’Œåˆ—ä»¥é¢„è§ˆåˆ†ç»„ç»“æœ</span>
                </div>
            </div>             <div class="flex items-center justify-between p-4 bg-white border-t border-gray-100">
                <span class="text-[17px]">å¯¼å‡ºç”»è´¨</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="customQ_small" min="30" max="100" value="90" class="hidden bg-gray-100 rounded px-2 py-1 text-center w-14 text-[15px] font-bold text-[#007AFF] outline-none" placeholder="90" onchange="validateQualityInput(this)">
                    <span id="customQ_unit_small" class="hidden text-xs text-gray-500 mr-1">%</span>
                    <select id="exportQuality_small" onchange="toggleQualityInput('small')" class="text-[#007AFF] text-[15px] bg-transparent focus:outline-none text-right dir-rtl cursor-pointer">
                        <option value="0.95">é«˜æ¸… (JPEG 95%)</option>
                        <option value="0.80">æ ‡å‡†å‹ç¼© (JPEG 80%)</option>
                        <option value="1.0">åŸå›¾æ— æŸ (PNG)</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
            </div>
        </div><div id="group-panel-large" class="ios-card ios-divide mb-6 hidden">
            <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[17px] font-bold">åå°åˆ†ç»„å¤„ç†</span>
                    <div class="flex items-center gap-2">
                        <input type="number" id="imagesPerBatch" value="50" class="bg-gray-100 rounded px-2 py-1 text-center w-16 text-[15px] font-bold text-[#007AFF]" onchange="validateBatchInput()">
                        <span class="text-xs text-gray-400">å¼ /ç»„</span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-400 leading-tight">
                    *å¯¼å‡ºçš„åˆ—æ•°=æ‚¨ä¸€å¼€å§‹åœ¨æœ€ä¸Šé¢å¡«å†™çš„â€œåˆ—æ•°ï¼ˆæ¨ªå‘ï¼‰â€ï¼Œé€‚ç”¨äº100å¼ ä»¥ä¸Šæ‹¼å›¾æˆ–è€…åæœŸåˆ†ç»„å¯¼å‡ºã€‚
                   ä¾‹: å¡«9å¼ /ç»„ï¼Œå¯æŒ‰ä½ æ‰€å¡«çš„åˆ—æ•°9å¼ /ç»„ä¸€å¼ å¼ å¯¼å‡ºã€‚å»ºè®®åˆç†å¡«å†™ï¼Œå¦åˆ™æ‹¼å›¾å¯èƒ½ä¼šç•™ç©ºç™½ã€‚
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <div class="text-[13px] font-medium text-gray-800 mb-3 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    è‡ªå®šä¹‰å¯¼å‡ºå¸ƒå±€ (å¯é€‰)
                </div>
                <div class="flex gap-4 mb-2">
                    <div class="flex-1">
                        <label class="text-[11px] text-gray-500 block mb-1">å¯¼å‡ºåˆ—æ•°</label>
                        <input type="number" id="exportCols" placeholder="åŒé¢„è§ˆ" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm focus:border-[#007AFF] outline-none" oninput="calculateBatchSize()">
                    </div>
                    <div class="flex-1">
                        <label class="text-[11px] text-gray-500 block mb-1">å¯¼å‡ºè¡Œæ•°/ç»„</label>
                        <input type="number" id="exportRows" placeholder="è‡ªåŠ¨" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm focus:border-[#007AFF] outline-none" oninput="calculateBatchSize()">
                    </div>
                </div>
                
                <div class="text-[11px] text-gray-400 bg-white/50 p-2 rounded border border-gray-100 leading-relaxed" id="layoutHint">
                    <span class="block mb-0.5">* è®¾ç½®åå°†æŒ‰ <b>"åˆ— Ã— è¡Œ"</b> é”å®šæ¯ç»„å¼ æ•°ã€‚</span>
                    <span>* ä¾‹å¦‚ï¼šè®¾ç½® 3åˆ— Ã— 5è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ¯ç»„è®¾ä¸º 15å¼ ã€‚</span>
                </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-white border-t border-gray-100">
                <span class="text-[17px]">å¯¼å‡ºç”»è´¨</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="customQ_large" min="30" max="100" value="90" class="hidden bg-gray-100 rounded px-2 py-1 text-center w-14 text-[15px] font-bold text-[#007AFF] outline-none" placeholder="90" onchange="validateQualityInput(this)">
                    <span id="customQ_unit_large" class="hidden text-xs text-gray-500 mr-1">%</span>
                    <select id="exportQuality" onchange="toggleQualityInput('large')" class="text-[#007AFF] text-[15px] bg-transparent focus:outline-none text-right dir-rtl cursor-pointer">
                        <option value="0.95">é«˜æ¸… (JPEG 95%)</option>
                        <option value="0.80">æ ‡å‡†å‹ç¼© (JPEG 80%)</option>
                        <option value="1.0">åŸå›¾æ— æŸ (PNG)</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
            </div>
        </div>
<div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">æ‰“ç  / è´´çº¸ (æ‹¼å›¾ååº”ç”¨)</div>
        <div class="ios-card ios-divide">
            <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex flex-col">
                        <span class="text-[17px] font-bold">ç›®æ ‡åºå·</span>
                        <span class="text-[10px] text-gray-400">è¾“å…¥æ•°å­— (å¦‚: 5, 12, 1-3)</span>
                    </div>
                    <input type="text" id="maskIndices" placeholder="å¦‚: 5, 12" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-40 placeholder-gray-300 bg-gray-50 rounded px-2 py-1">
                </div>

                <div class="flex p-1 bg-gray-100 rounded-lg mb-4">
                    <button onclick="switchMaskTab('line')" id="tab-line" class="flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all">ç”»çº¿æ‰“ç </button>
                    <button onclick="switchMaskTab('image')" id="tab-image" class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">å›¾ç‰‡/è´´çº¸</button>
                </div>

                <div id="mask-panel-line" class="animate-fade-in">
                    <div class="flex justify-between items-center pb-3 border-b border-gray-100 mb-3">
                        <span class="text-sm text-gray-500">å½¢çŠ¶æ ·å¼</span>
                        <div class="flex items-center gap-4 text-sm">
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="lineStyle" value="cross" checked class="accent-[#FF3B30]"> <span>âŒ äº¤å‰</span></label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="lineStyle" value="slash" class="accent-[#FF3B30]"> <span>â•± æ–œçº¿</span></label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2">
                         <span class="text-sm text-gray-500 w-20">é¢œè‰²/ç²—ç»†</span>
                         <div class="flex items-center flex-1 gap-3">
                             <input type="color" id="maskColor" value="#FF3B30" class="w-8 h-8 rounded-full border border-gray-200 shrink-0">
                             <div class="flex-1 h-8 flex items-center"><input type="range" id="maskWidth" min="1" max="20" value="10" class="w-full"></div>
                         </div>
                    </div>
                </div>

                <div id="mask-panel-image" class="hidden animate-fade-in">
                    <button onclick="document.getElementById('stickerInput').click()" class="w-full py-2 border border-dashed border-gray-300 rounded-lg text-gray-500 text-sm mb-3 active:bg-gray-50">+ ä¸Šä¼ é®æŒ¡å›¾ (Logo/è´´çº¸)</button>
                    <div class="flex gap-4 mb-1">
                        <div class="w-24 h-24 checkered-bg rounded-lg overflow-hidden border border-gray-200 shrink-0 relative cursor-pointer active:scale-95 transition shadow-sm" onclick="enlargeStickerPreview()">
                            <canvas id="stickerPreviewCanvas" class="w-full h-full object-contain"></canvas>
                        </div>
                        <div class="flex-1 flex flex-col justify-center space-y-4">
                            <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">å¤§å°</span> <input type="range" id="stickerSize" min="10" max="200" value="50" class="flex-1"></div>
                            <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">å·¦å³</span> <input type="range" id="stickerX" min="0" max="100" value="50" class="flex-1"></div>
                            <div class="flex items-center text-xs text-gray-500"><span class="w-8 text-right mr-3">ä¸Šä¸‹</span> <input type="range" id="stickerY" min="0" max="100" value="50" class="flex-1"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 pt-0 grid grid-cols-2 gap-3 bg-white pb-4 rounded-b-xl">
                <button onclick="generateMasked('apply')" class="py-3 rounded-xl bg-[#007AFF]/10 active:bg-[#007AFF]/20 text-[#007AFF] font-bold text-[15px] transition-all flex items-center justify-center gap-1">âœ¨ ç”Ÿæˆ/æ›´æ–°</button>
                <button onclick="generateMasked('repack')" class="py-3 rounded-xl bg-[#FF3B30]/10 active:bg-[#FF3B30]/20 text-[#FF3B30] font-bold text-[15px] transition-all flex items-center justify-center gap-1">ğŸ”„ å‰”é™¤å¹¶é‡æ’</button>
            </div></div> <div id="resultArea" class="hidden pb-10"><div class="text-center text-gray-400 text-xs mb-3 font-medium">é¢„è§ˆç»“æœ (æ— ç¼æ‹¼æ¥)</div>
            <div class="ios-card bg-white p-0 shadow-lg overflow-hidden border border-gray-100">
                <div id="seamlessContainer" class="w-full flex flex-col bg-white"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="downloadZip()" class="col-span-2 bg-[#34C759] text-white text-[16px] font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    <span>æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ†ç»„ (ZIP)</span>
                </button>
                <button onclick="combineAndDownload()" class="bg-white text-black border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾</button>
                <button onclick="downloadAllParts()" class="bg-white text-[#007AFF] border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">é€å¼ ä¸‹è½½</button>
            </div>
        </div>

        <div class="py-10 pb-20 text-center">
    <div class="space-y-1">
        <p class="text-xs text-gray-500 font-medium">æ‹¼å›¾Ultimate (Pro Max)</p>
        <p class="text-[10px] text-gray-400">Designed by   ikko</p>
        
        <p class="text-[10px] text-gray-400">è¯·ä¸è¦äºŒä¼ 
        
å‘ç°äºŒä¼ æˆ‘ä¼šåˆ é“¾æ¥ è‡ªç”¨çš„|||</p>
    </div>
</div>

    </main><div class="fixed bottom-8 left-0 right-0 px-4 z-40 pointer-events-none">
        <button onclick="generate()" class="pointer-events-auto w-full max-w-2xl mx-auto bg-white/80 backdrop-blur-md text-black border border-white/40 font-semibold text-[17px] py-3.5 rounded-full shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
            <span>âœ¨ å¼€å§‹ç”Ÿæˆæ‹¼å›¾</span>
        </button>
    </div>

    
    <canvas id="canvas" class="hidden"></canvas>
    <div id="previewModal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="bg-white p-2 rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center" style="max-width:90%; max-height:80%;" onclick="event.stopPropagation()">
            <canvas id="enlargedPreviewCanvas" class="object-contain" style="max-width:100%; max-height:70vh;"></canvas>
            <button onclick="document.getElementById('previewModal').style.display='none'" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
    </div>
    
    <div id="imageActionOverlay" class="modal-overlay" onclick="closeImageActions()"></div>
    <div id="imageActionSheet" class="action-sheet">
        <div class="text-center text-gray-400 text-sm mb-4 font-medium">å›¾ç‰‡æ“ä½œ</div>
        <div class="space-y-3">
            <button onclick="triggerReplace()" class="w-full bg-white text-[#007AFF] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">æ›¿æ¢å›¾ç‰‡</button>
            <button onclick="triggerDelete()" class="w-full bg-white text-[#FF3B30] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">åˆ é™¤å›¾ç‰‡</button>
        </div>
        <button onclick="closeImageActions()" class="w-full bg-white text-black font-semibold text-[17px] py-3.5 rounded-xl shadow-sm mt-4 active:bg-gray-50">å–æ¶ˆ</button>
    </div><button onclick="toggleHelpModal(true)" class="fixed bottom-28 right-5 z-40 bg-white/90 backdrop-blur shadow-lg border border-gray-200 w-12 h-12 rounded-full flex items-center justify-center text-[#007AFF] active:scale-90 transition-transform">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
</button>

<div id="helpModal" class="modal-overlay z-[110]" onclick="toggleHelpModal(false)">
    <div class="bg-[#F2F2F7] w-full max-w-lg h-[80vh] rounded-t-2xl md:rounded-2xl flex flex-col overflow-hidden shadow-2xl transform transition-transform translate-y-full md:translate-y-0" id="helpModalContent" onclick="event.stopPropagation()">
        
        <div class="bg-white px-4 py-3 flex justify-between items-center border-b border-gray-200">
            <h3 class="text-[17px] font-bold">ä½¿ç”¨æ•™ç¨‹ & è¯´æ˜</h3>
            <button onclick="toggleHelpModal(false)" class="bg-gray-100 hover:bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center text-gray-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-3">
            
            <div class="ios-card overflow-hidden">
                <button onclick="toggleHelpItem('help-layout')" class="w-full flex justify-between items-center p-4 bg-white active:bg-gray-50 transition">
                    <span class="text-[15px] font-bold text-gray-800">1. åŸºç¡€å¸ƒå±€ä¸æ¯”ä¾‹</span>
                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-help-layout" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="help-layout" class="hidden px-4 pb-4 text-[13px] text-gray-500 leading-relaxed bg-white border-t border-gray-100 pt-2">
                    <p class="mb-2"><strong>åˆ—æ•°ï¼š</strong>å†³å®šæ¨ªå‘æ’å‡ å¼ å›¾ã€‚è¡Œæ•°ä¼šæ ¹æ®å›¾ç‰‡æ€»æ•°è‡ªåŠ¨è®¡ç®—ã€‚ï¼ˆå…¶å®æ„Ÿè§‰å¯ä»¥å¿½è§†è¿™ä¸ªï¼Œå› ä¸ºå¦‚æœä½ è¿™å¡«5ï¼Œè€Œåˆ†ç»„å¯¼å‡ºé‚£åˆ—æ•°å¡«6ï¼Œä¼šæŒ‰åˆ†ç»„å¯¼å‡ºçš„åˆ—æ•°æ¥ã€‚
åˆ†ç»„å¯¼å‡ºå¸ƒå±€è®¾ç½®ä¼˜å…ˆä¸ºåŸåˆ™ï¼‰</p>
                    <p class="mb-2"><strong>ç”»å¸ƒæ¯”ä¾‹ï¼š</strong>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><b>3:4 / 9:16ï¼š</b>é€‚åˆæ‰‹æœºå£çº¸æˆ–é•¿æµ·æŠ¥ã€‚</li>
                        <li><b>1:1ï¼š</b>é€‚åˆæ­£æ–¹å½¢æ’ç‰ˆã€‚</li>
                        <li><b>è‡ªå®šä¹‰ï¼š</b>å¦‚æœæœ‰ç‰¹æ®Šå°ºå¯¸éœ€æ±‚ï¼Œå¯é€‰è‡ªå®šä¹‰è¾“å…¥å®½å’Œé«˜ã€‚</li>
                    </ul>
                    </p>
                </div>
            </div>

            <div class="ios-card overflow-hidden">
                <button onclick="toggleHelpItem('help-num')" class="w-full flex justify-between items-center p-4 bg-white active:bg-gray-50 transition">
                    <span class="text-[15px] font-bold text-gray-800">2. åºå·æ ‡æ³¨è®¾ç½®</span>
                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-help-num" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="help-num" class="hidden px-4 pb-4 text-[13px] text-gray-500 leading-relaxed bg-white border-t border-gray-100 pt-2">
                    <p class="mb-2">ç³»ç»Ÿä¼šè‡ªåŠ¨ç»™æ¯å¼ å›¾ç‰‡æ‰“ä¸Šæ•°å­—ã€‚</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><b>èµ·å§‹æ•°å€¼ï¼š</b>é»˜è®¤ä»1å¼€å§‹ã€‚å¦‚æœè¿™æ˜¯ç¬¬äºŒç»„æ‹¼å›¾ï¼Œä½ å¯ä»¥è®¾ä¸º51ï¼Œæ¥ä¸Šä¸€ç»„çš„é¡ºåºã€‚</li>
                        <li><b>å­—å·ä¸ä½ç½®ï¼š</b>è§‰å¾—æ•°å­—å¤ªå°æˆ–æŒ¡ä½ä¸»ä½“ï¼Œå¯è°ƒæ•´å¤§å°æˆ–å°†å…¶ç§»åˆ°è§’è½ã€‚</li>
                    </ul>
                </div>
            </div>

                        <div class="ios-card overflow-hidden">
                <button onclick="toggleHelpItem('help-export')" class="w-full flex justify-between items-center p-4 bg-white active:bg-gray-50 transition">
                    <span class="text-[15px] font-bold text-gray-800">3. åˆ†ç»„ä¸å¯¼å‡ºç­–ç•¥</span>
                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-help-export" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="help-export" class="hidden px-4 pb-4 text-[13px] text-gray-500 leading-relaxed bg-white border-t border-gray-100 pt-2">
                    <p class="mb-3">æ ¹æ®å›¾ç‰‡æ•°é‡é€‰æ‹©ä¸åŒçš„æ¨¡å¼ï¼š</p>
                    <div class="bg-gray-50 p-2 rounded mb-2">
                        <span class="font-bold text-gray-800 block mb-1">æ¨¡å¼ Aï¼š100å¼ ä»¥ä¸‹ (åˆ†ç»„)</span>
                        æ­¤æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸€å¼ å¤§å›¾é‡ŒåŒ…å«å‡ è¡Œå‡ åˆ—ã€‚<br>
                        <span class="text-gray-500 text-xs">ä¾‹ï¼šè®¾ç½®3åˆ—5è¡Œï¼Œç³»ç»Ÿå°±ä¼šæ¯15å¼ å›¾åˆ‡æˆä¸€å¼ å¤§å›¾å¯¼å‡ºã€‚</span>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <span class="font-bold text-gray-800 block mb-1">æ¨¡å¼ Bï¼š100å¼ ä»¥ä¸Š (åå°)</span>
                        é€‚åˆè¶…å¤§é‡å›¾ç‰‡ã€‚ä¸ºäº†é˜²æ­¢æµè§ˆå™¨å¡æ­»ï¼Œç³»ç»Ÿä¼šé‡‡ç”¨â€œæ¯ç»„Xå¼ â€çš„æ–¹å¼åˆ†æ‰¹å¤„ç†ã€‚<br>
                        <span class="text-xs text-gray-400">å»ºè®®ä¿æŒé»˜è®¤50å¼ /ç»„ï¼Œç”Ÿæˆåä½¿ç”¨â€œæ‰“åŒ…ä¸‹è½½ZIPâ€ã€‚
ï¼ˆå…¶å®æˆ‘æ„Ÿè§‰è¿™ä¸¤å¯ä»¥åˆå¹¶ï¼Œéƒ½æ˜¯å¯ä»¥è‡ªå®šä¹‰å¤šå°‘å¼ å¯¼å‡ºï¼Œéƒ½æ˜¯ä¸€ä¸ªåŸç†ï¼Œæ²¡ä»€ä¹ˆå½±å“ï¼Œå¥½åƒä¸¤ç™¾å¼ ä¹Ÿå¯ä»¥ç”¨æ¨¡å¼Aï¼Œä¸æƒ³æ”¹äº†ã€‚è‡ªå·±æ£é¼“ç”¨å§ï¼‰</span>
                    </div>
                </div>
            </div>


            <div class="ios-card overflow-hidden">
                <button onclick="toggleHelpItem('help-mask')" class="w-full flex justify-between items-center p-4 bg-white active:bg-gray-50 transition">
                    <span class="text-[15px] font-bold text-gray-800">4. æ‰“ç ä¸è´´çº¸</span>
                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-help-mask" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="help-mask" class="hidden px-4 pb-4 text-[13px] text-gray-500 leading-relaxed bg-white border-t border-gray-100 pt-2">
                    <p class="mb-2">ç”Ÿæˆæ‹¼å›¾åï¼Œå¦‚æœä½ æƒ³é®ç›–æŸäº›å›¾ç‰‡ï¼ˆå¦‚å·²å”®å‡ºï¼‰ï¼š</p>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>åœ¨<b>â€œç›®æ ‡åºå·â€</b>æ¡†å†…è¾“å…¥æ•°å­—ï¼ˆå¦‚ï¼š5, 12-15ï¼‰ã€‚</li>
                        <li>é€‰æ‹©<b>ç”»çº¿</b>ï¼ˆæ‰“çº¢å‰ï¼‰æˆ–<b>å›¾ç‰‡/è´´çº¸</b>ï¼ˆä¸Šä¼ Logoé®ç›–ï¼‰ã€‚</li>
                        <li>ç‚¹å‡»<b>â€œâœ¨ ç”Ÿæˆ/æ›´æ–°â€</b>å³å¯çœ‹åˆ°æ•ˆæœã€‚</li>
                        <li>ç‚¹å‡»<b>â€œğŸ”„ å‰”é™¤å¹¶é‡æ’â€</b>ä¼šå°†è¿™äº›å›¾ç‰‡ç›´æ¥åˆ é™¤ï¼Œå°†å‰©ä¸‹çš„å›¾é‡æ–°æ‹¼æ¥ã€‚</li>
                    </ol>
                </div>
            </div>

            <div class="text-center text-[11px] text-gray-400 py-4">
                Designed by ikko | æ‹¼å›¾Ultimate
            </div>
        </div>
    </div>
</div><script>let imagesData = [];
    let generatedBlobs = [];
    let stickerImg = null;
    let currentMaskMode = 'line';
    let targetImageIndex = -1; 
    let isCancelled = false;
    let currentMode = 'small'; // é»˜è®¤ä¸ºå°æ•°æ®é‡åˆ†ç»„æ¨¡å¼

    const MAX_CANVAS_DIMENSION = 8192;

    // --- æ¨¡å¼åˆ‡æ¢é€»è¾‘ ---
    function switchMode(mode) {
        currentMode = mode;
        const btnSmall = document.getElementById('btn-small');
        const btnLarge = document.getElementById('btn-large');
        const panelSmall = document.getElementById('group-panel-small');
        const panelLarge = document.getElementById('group-panel-large');
        const indicator = document.getElementById('mode-indicator');

        if (mode === 'small') {
            btnSmall.classList.remove('text-gray-500');
            btnLarge.classList.add('text-gray-500');
            panelSmall.classList.remove('hidden');
            panelLarge.classList.add('hidden');
            indicator.style.transform = 'translateX(0)';
            calculateSmallBatch();
        } else {
            btnSmall.classList.add('text-gray-500');
            btnLarge.classList.remove('text-gray-500');
            panelSmall.classList.add('hidden');
            panelLarge.classList.remove('hidden');
            indicator.style.transform = 'translateX(100%)';
        }
    }

    // --- å°åˆ†ç»„è®¡ç®—é€»è¾‘ ---
    function calculateSmallBatch() {
        if(currentMode !== 'small') return;
        const cols = parseInt(document.getElementById('small_cols').value) || 0;
        const rows = parseInt(document.getElementById('small_rows').value) || 0;
        const hint = document.getElementById('small_hint');
        const total = imagesData.length;
        
        if (cols > 0 && rows > 0) {
            const batchSize = cols * rows;
            const groups = Math.ceil(total / batchSize);
            hint.innerHTML = `<span class="text-[#007AFF] font-bold">âœ… å·²å°±ç»ª:</span> <span>å°†åˆ†ä¸º <b>${groups}</b> ç»„ï¼Œæ¯ç»„ <b>${batchSize}</b> å¼  (${cols}åˆ—x${rows}è¡Œ)</span>`;
            hint.className = "mt-3 text-[11px] bg-[#007AFF]/5 text-[#007AFF] border border-[#007AFF]/20 p-2 rounded flex items-center gap-2";
        } else {
            hint.innerHTML = `<span class="font-bold">Waiting...</span><span>è¯·è®¾ç½®è¡Œå’Œåˆ—ä»¥é¢„è§ˆåˆ†ç»„ç»“æœ</span>`;
            hint.className = "mt-3 text-[11px] text-gray-500 bg-[#F2F2F7] p-2 rounded flex items-center gap-2";
        }
    }function switchMaskTab(mode) {
        currentMaskMode = mode;
        const lineTab = document.getElementById('tab-line');
        const imgTab = document.getElementById('tab-image');
        lineTab.className = mode==='line' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        imgTab.className = mode==='image' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        document.getElementById('mask-panel-line').style.display = mode==='line' ? 'block' : 'none';
        document.getElementById('mask-panel-image').style.display = mode==='image' ? 'block' : 'none';
        if(mode === 'image') updateStickerPreview();
    }

    // --- ä¼˜åŒ–çš„è¿›åº¦æ¡æ§åˆ¶é€»è¾‘ (é¡¶éƒ¨æ‚¬æµ®æ¡) ---
    function showLoading(show, text='å¤„ç†ä¸­...') {
        const toast = document.getElementById('progressToast');
        const textField = document.getElementById('progressText');
        const detailField = document.getElementById('progressDetail');
        const bar = document.getElementById('progressBar');

        if (show) { 
            isCancelled = false;
            if(toast) {
                toast.classList.remove('-translate-y-[200%]', 'opacity-0', 'pointer-events-none');
                toast.classList.add('translate-y-0', 'opacity-100');
            }
            if(textField) textField.innerText = text;
            if(bar && detailField) {
                if(text.includes('åˆå§‹åŒ–')) {
                    bar.style.width = '5%';
                    detailField.innerText = 'Start';
                } else if (text.includes('ç”Ÿæˆç¬¬')) {
                    try {
                        const parts = text.match(/(\d+)\s*\/\s*(\d+)/);
                        if(parts && parts.length === 3) {
                            const current = parseInt(parts[1]);
                            const total = parseInt(parts[2]);
                            const percent = Math.round((current / total) * 100);
                            bar.style.width = `${percent}%`;
                            detailField.innerText = `${percent}%`;
                        }
                    } catch(e) {}
                }
            }
        } else { 
            if(bar) bar.style.width = '100%';
            if(detailField) detailField.innerText = '100%';
            setTimeout(() => {
                if(toast) {
                    toast.classList.add('-translate-y-[200%]', 'opacity-0', 'pointer-events-none');
                    toast.classList.remove('translate-y-0', 'opacity-100');
                }
                setTimeout(() => { if(bar) bar.style.width = '0%'; }, 500);
            }, 800);
        }
    }
    
    function cancelProcess() {
        const toast = document.getElementById('progressToast');
        if(toast) {
            toast.classList.add('scale-95');
            setTimeout(() => toast.classList.remove('scale-95'), 100);
        }
        if(confirm('ç¡®å®šè¦åœæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
            isCancelled = true;
            const textField = document.getElementById('progressText');
            if(textField) textField.innerText = "æ­£åœ¨å–æ¶ˆ...";
            setTimeout(() => showLoading(false), 500);
        }
    }function toggleCustomRatio() { document.getElementById('customRatioBox').style.display = (document.getElementById('aspectRatio').value === 'custom') ? 'flex' : 'none'; }
    function validateBatchInput() { let val = parseInt(document.getElementById('imagesPerBatch').value); if(val < 1) document.getElementById('imagesPerBatch').value = 1; }
    
    function handleFiles(files) {
        if (!files.length) return;
        const grid = document.getElementById('imageGrid');
        const fragment = document.createDocumentFragment();
        const startIndex = imagesData.length;
        Array.from(files).forEach((file, i) => {
            const url = URL.createObjectURL(file);
            imagesData.push(url);
            const div = document.createElement('div');
            div.className = 'relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-100 thumbnail-item active:opacity-80 transition cursor-pointer';
            div.innerHTML = `<img src="${url}" class="w-full h-full object-cover pointer-events-none">`;
            div.onclick = () => openImageActions(startIndex + i);
            fragment.appendChild(div);
        });
        grid.appendChild(fragment);
        refreshUI();
        calculateSmallBatch();
        document.getElementById('fileInput').value = '';
    }

    function openImageActions(index) { targetImageIndex = index; document.getElementById('imageActionOverlay').style.display = 'block'; setTimeout(() => document.getElementById('imageActionSheet').classList.add('show'), 10); }
    function closeImageActions() { document.getElementById('imageActionSheet').classList.remove('show'); setTimeout(() => document.getElementById('imageActionOverlay').style.display = 'none', 300); }
    function triggerReplace() { document.getElementById('replaceInput').click(); closeImageActions(); }
    function handleReplaceAction(files) {
        if(!files.length || targetImageIndex === -1) return;
        const url = URL.createObjectURL(files[0]);
        imagesData[targetImageIndex] = url;
        const item = document.querySelectorAll('.thumbnail-item img')[targetImageIndex];
        if(item) item.src = url;
        document.getElementById('replaceInput').value = '';
    }
    function triggerDelete() {
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            imagesData.splice(targetImageIndex, 1);
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '<div id="emptyState" class="col-span-full py-8 text-center" style="display:none"><span class="text-gray-400">å¯¼å…¥å›¾ç‰‡</span></div>';
            const fragment = document.createDocumentFragment();
            imagesData.forEach((url, i) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-100 thumbnail-item active:opacity-80 transition cursor-pointer';
                div.innerHTML = `<img src="${url}" class="w-full h-full object-cover pointer-events-none">`;
                div.onclick = () => openImageActions(i);
                fragment.appendChild(div);
            });
            grid.appendChild(fragment);
            refreshUI();
            calculateSmallBatch();
        }
        closeImageActions();
    }
    function refreshUI() {
        document.getElementById('countBadge').innerText = imagesData.length;
        document.getElementById('emptyState').style.display = imagesData.length ? 'none' : 'flex';
        document.getElementById('clearBtn').style.display = imagesData.length ? 'block' : 'none';
        updateStickerPreview();
        calculateBatchSize(); // For large mode
    }
    function clearAll() { if(confirm('ç¡®å®šæ¸…ç©º?')) { imagesData=[]; refreshUI(); document.getElementById('imageGrid').innerHTML = ''; document.getElementById('imageGrid').appendChild(document.getElementById('emptyState')); document.getElementById('emptyState').style.display = 'flex'; } }
    
    function handleStickerFile(files) { if(!files.length) return; const img = new Image(); img.onload = () => { stickerImg = img; updateStickerPreview(); }; img.src = URL.createObjectURL(files[0]); }
    function getCurrentRatio() {
        let ratio = parseFloat(document.getElementById('aspectRatio').value);
        if(isNaN(ratio) || document.getElementById('aspectRatio').value === 'custom') {
            const cw = parseInt(document.getElementById('customW').value) || 1000;
            const ch = parseInt(document.getElementById('customH').value) || 1500;
            ratio = cw / ch;
        }
        return ratio;
    }
    function updateStickerPreview() {
        const canvas = document.getElementById('stickerPreviewCanvas'); const ctx = canvas.getContext('2d');
        const w = canvas.width = 300; const h = canvas.height = 300;
        ctx.clearRect(0,0,w,h);
        if (imagesData.length > 0) {
            const bgImg = new Image(); bgImg.src = imagesData[0];
            if(bgImg.complete) drawPreviewContent(ctx, w, h, bgImg); else bgImg.onload = () => drawPreviewContent(ctx, w, h, bgImg);
        } else { ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0,0,w,h); ctx.fillStyle = '#ccc'; ctx.textAlign = 'center'; ctx.fillText('æ— å›¾', w/2, h/2); }
    }
    function drawPreviewContent(ctx, w, h, bgImg) {
        const sRatio = bgImg.width / bgImg.height; const cRatio = w / h;
        if(sRatio > cRatio) ctx.drawImage(bgImg, (bgImg.width - bgImg.height*cRatio)/2, 0, bgImg.height*cRatio, bgImg.height, 0, 0, w, h);
        else ctx.drawImage(bgImg, 0, (bgImg.height - bgImg.width/cRatio)/2, bgImg.width, bgImg.width/cRatio, 0, 0, w, h);
        if (stickerImg) {
            const sizePct = document.getElementById('stickerSize').value / 100;
            const xPct = document.getElementById('stickerX').value / 100;
            const yPct = document.getElementById('stickerY').value / 100;
            const sw = w * sizePct; const sh = sw * (stickerImg.height / stickerImg.width);
            ctx.drawImage(stickerImg, (w * xPct) - sw/2, (h * yPct) - sh/2, sw, sh);
        }
    }
    function enlargeStickerPreview() {
        const modal = document.getElementById('previewModal');
        const largeCanvas = document.getElementById('enlargedPreviewCanvas');
        const ratio = getCurrentRatio();
        const baseW = 600; const baseH = baseW / ratio;
        largeCanvas.width = baseW; largeCanvas.height = baseH;
        const ctx = largeCanvas.getContext('2d');
        if (imagesData.length > 0) {
            const bgImg = new Image(); bgImg.src = imagesData[0];
            bgImg.onload = () => { drawPreviewContent(ctx, baseW, baseH, bgImg); modal.style.display = 'flex'; }
        } else { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,baseW,baseH); modal.style.display = 'flex'; }
    }    function calculateBatchSize() {
        if(currentMode === 'small') return;
        const exCols = parseInt(document.getElementById('exportCols').value);
        const exRows = parseInt(document.getElementById('exportRows').value);
        const batchInput = document.getElementById('imagesPerBatch');
        const hint = document.getElementById('layoutHint');
        const totalImages = imagesData.length || 0; 
        if (exCols > 0 && exRows > 0) {
            const perBatch = exCols * exRows;
            batchInput.value = perBatch;
            const batches = totalImages > 0 ? Math.ceil(totalImages / perBatch) : 0;
            batchInput.disabled = true; batchInput.classList.add('opacity-50');
            hint.innerHTML = `<div class="text-[#007AFF] font-medium mb-0.5">âœ… é”å®šå¸ƒå±€ï¼š${exCols}åˆ— Ã— ${exRows}è¡Œ = ${perBatch}å¼ /ç»„</div>`;
            hint.classList.add('bg-[#007AFF]/5', 'border-[#007AFF]/20');
        } else {
            batchInput.disabled = false; batchInput.classList.remove('opacity-50');
            hint.innerHTML = `<span class="block mb-0.5">* è®¾ç½®åå°†æŒ‰ <b>"åˆ— Ã— è¡Œ"</b> é”å®šæ¯ç»„å¼ æ•°ã€‚</span>`;
            hint.classList.remove('bg-[#007AFF]/5', 'border-[#007AFF]/20');
        }
    }

    // --- æ–°å¢ï¼šç”»è´¨æ§åˆ¶é€»è¾‘ ---
    function toggleQualityInput(type) {
        const selectId = type === 'small' ? 'exportQuality_small' : 'exportQuality';
        const inputId = type === 'small' ? 'customQ_small' : 'customQ_large';
        const unitId = type === 'small' ? 'customQ_unit_small' : 'customQ_unit_large';

        const val = document.getElementById(selectId).value;
        const isCustom = val === 'custom';
        
        const inputEl = document.getElementById(inputId);
        const unitEl = document.getElementById(unitId);
        
        if (isCustom) {
            inputEl.classList.remove('hidden');
            unitEl.classList.remove('hidden');
        } else {
            inputEl.classList.add('hidden');
            unitEl.classList.add('hidden');
        }
    }

    function validateQualityInput(el) {
        let val = parseInt(el.value);
        if (isNaN(val)) val = 90;
        // ä¿®æ”¹ï¼šæœ€å°å€¼æ”¹ä¸º 30
        if (val < 30) val = 30;
        if (val > 100) val = 100;
        el.value = val;
    }
async function generate() { await runGeneration('normal'); }
    async function generateMasked(type) { await runGeneration(type); }

    async function runGeneration(opType) {
        if (!imagesData.length) return alert('è¯·æ·»åŠ å›¾ç‰‡');
        const container = document.getElementById('seamlessContainer');
        container.innerHTML = ''; generatedBlobs = [];
        
        const startNum = parseInt(document.getElementById('startNumber').value) || 1;
        let targets = [...imagesData];
        
        // --- é®ç½©ç›®æ ‡è§£æ ---
        const rawInput = document.getElementById('maskIndices').value;
        let maskTargets = [];
        const parts = rawInput.split(/[,ï¼Œ\s]+/);
        parts.forEach(part => {
            part = part.trim(); if (!part) return;
            if (part.includes('-')) {
                const rangeParts = part.split('-');
                if (rangeParts.length === 2) {
                    const s = parseInt(rangeParts[0]); const e = parseInt(rangeParts[1]);
                    if (!isNaN(s) && !isNaN(e)) { for (let k = Math.min(s,e); k <= Math.max(s,e); k++) maskTargets.push(k); }
                }
            } else { const num = parseInt(part); if (!isNaN(num)) maskTargets.push(num); }
        });
        if (opType === 'repack') targets = targets.filter((_, i) => !maskTargets.includes(startNum + i));

        // --- æ ¸å¿ƒé€»è¾‘åŒºåˆ† ---
        let batchSize, finalCols;
        let quality = 0.95; 
        let isPng = false;
        
        if (currentMode === 'small') {
            const sCols = parseInt(document.getElementById('small_cols').value) || 3;
            const sRows = parseInt(document.getElementById('small_rows').value) || 100;
            finalCols = sCols;
            batchSize = sCols * sRows;
            
            // è·å–ç”»è´¨
            const qVal = document.getElementById('exportQuality_small').value;
            if (qVal === 'custom') {
                const customVal = parseInt(document.getElementById('customQ_small').value) || 90;
                quality = customVal / 100;
                isPng = false; 
            } else {
                quality = parseFloat(qVal);
                isPng = (quality === 1.0);
            }
        } else {
            batchSize = parseInt(document.getElementById('imagesPerBatch').value) || 50;
            const customExportCols = parseInt(document.getElementById('exportCols').value);
            const previewCols = parseInt(document.getElementById('cols').value) || 3;
            finalCols = (customExportCols > 0) ? customExportCols : previewCols;

            // è·å–ç”»è´¨
            const qVal = document.getElementById('exportQuality').value;
            if (qVal === 'custom') {
                const customVal = parseInt(document.getElementById('customQ_large').value) || 90;
                quality = customVal / 100;
                isPng = false;
            } else {
                quality = parseFloat(qVal);
                isPng = (quality === 1.0);
            }
        }

        const totalBatches = Math.ceil(targets.length / batchSize);
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        showLoading(true, 'åˆå§‹åŒ–...');
        try {
            for (let b = 0; b < totalBatches; b++) {
                if (isCancelled) break;
                showLoading(true, `ç”Ÿæˆç¬¬ ${b+1} / ${totalBatches} ç»„...`);
                const currentImgs = targets.slice(b*batchSize, Math.min((b+1)*batchSize, targets.length));
                
                const ratio = getCurrentRatio();
                const gap = parseInt(document.getElementById('gap').value) || 0;
                
                let cellW = 1500; 
                if (finalCols * cellW > MAX_CANVAS_DIMENSION) cellW = Math.floor((MAX_CANVAS_DIMENSION - (finalCols*gap)) / finalCols);
                let cellH = Math.floor(cellW / ratio);
                const rows = Math.ceil(currentImgs.length / finalCols);

                await drawAsync(ctx, currentImgs, rows, finalCols, cellW, cellH, gap, b*batchSize, startNum, maskTargets, opType === 'apply');
                
                if (isCancelled) break;

                await new Promise(res => canvas.toBlob(blob => {
                    if (isCancelled) { res(); return; }
                    generatedBlobs.push(blob);
                    const img = document.createElement('img'); 
                    img.src = URL.createObjectURL(blob); img.className = "w-full block"; 
                    container.appendChild(img); res();
                }, isPng ? 'image/png' : 'image/jpeg', isPng ? undefined : quality));
                await new Promise(r => setTimeout(r, 50)); 
            }
            if (!isCancelled) { document.getElementById('resultArea').classList.remove('hidden'); document.getElementById('resultArea').scrollIntoView({behavior:'smooth'}); }
        } catch(e) { console.error(e); if(!isCancelled) alert('é”™è¯¯:'+e.message); }
        showLoading(false);
    }    async function drawAsync(ctx, imgs, rows, cols, w, h, gap, globalOffset, startNum, maskIndices, applyMask) {
        if (isCancelled) return;
        const canvas = ctx.canvas;
        canvas.width = cols * w + (cols-1) * gap; canvas.height = rows * h + (rows-1) * gap;
        ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const showNum = document.getElementById('showNum').checked;
        const fontSize = parseInt(document.getElementById('fontSize').value);
        const fontPos = document.getElementById('fontPos').value;
        const lineStyle = document.querySelector('input[name="lineStyle"]:checked') ? document.querySelector('input[name="lineStyle"]:checked').value : 'cross';

        for (let i = 0; i < imgs.length; i++) {
            if (isCancelled) return;
            const r = Math.floor(i / cols); const c = i % cols;
            const x = c * (w + gap); const y = r * (h + gap);
            const currentNum = startNum + globalOffset + i;

            const img = new Image(); img.src = imgs[i];
            await new Promise(resolve => { if(img.complete)resolve(); else img.onload=resolve; img.onerror=resolve; });

            ctx.save(); ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
            const iRatio = img.width / img.height; const cRatio = w / h;
            if (iRatio > cRatio) ctx.drawImage(img, x - (h*iRatio - w)/2, y, h*iRatio, h);
            else ctx.drawImage(img, x, y - (w/iRatio - h)/2, w, w/iRatio);
            ctx.restore();

            if (showNum) {
                ctx.fillStyle = '#FFFFFF'; ctx.strokeStyle = '#000000'; ctx.lineWidth = fontSize / 15;
                ctx.font = `bold ${fontSize}px sans-serif`;
                let tx = x + w/2, ty = y + h - fontSize/2;
                if(fontPos === 'center') ty = y + h/2 + fontSize/3; else if(fontPos.includes('top')) ty = y + fontSize + 20;
                if(fontPos.includes('left')) { tx = x + 20; ctx.textAlign = 'left'; } else if(fontPos.includes('right')) { tx = x + w - 20; ctx.textAlign = 'right'; } else ctx.textAlign = 'center';
                ctx.strokeText(currentNum, tx, ty); ctx.fillText(currentNum, tx, ty);
            }
            if (applyMask && maskIndices.includes(currentNum)) {
                if (currentMaskMode === 'line') {
                    ctx.beginPath(); ctx.strokeStyle = document.getElementById('maskColor').value;
                    ctx.lineWidth = document.getElementById('maskWidth').value * (w/500) * 5; ctx.lineCap = 'round';
                    if (lineStyle === 'cross') { ctx.moveTo(x+w*0.2, y+h*0.2); ctx.lineTo(x+w*0.8, y+h*0.8); ctx.moveTo(x+w*0.8, y+h*0.2); ctx.lineTo(x+w*0.2, y+h*0.8); } 
                    else { ctx.moveTo(x+w*0.2, y+h*0.8); ctx.lineTo(x+w*0.8, y+h*0.2); }
                    ctx.stroke();
                } else if (currentMaskMode === 'image' && stickerImg) {
                    const sizePct = document.getElementById('stickerSize').value / 100; const xPct = document.getElementById('stickerX').value / 100; const yPct = document.getElementById('stickerY').value / 100;
                    const sw = w * sizePct; const sh = sw * (stickerImg.height / stickerImg.width);
                    ctx.drawImage(stickerImg, x + (w * xPct) - sw/2, y + (h * yPct) - sh/2, sw, sh);
                }
            }
        }
    }
    function downloadZip() {
        if (!generatedBlobs.length) return alert('è¯·å…ˆç”Ÿæˆæ‹¼å›¾');
        showLoading(true, 'æ­£åœ¨æ‰“åŒ… ZIP...');
        const zip = new JSZip(); const folder = zip.folder("æ‹¼å›¾åˆ†ç»„");
        generatedBlobs.forEach((blob, i) => { const ext = blob.type === 'image/png' ? 'png' : 'jpg'; folder.file(`æ‹¼å›¾_Part_${i+1}.${ext}`, blob); });
        zip.generateAsync({type:"blob"}).then(function(content) { if(isCancelled) return; downloadBlob(content, `æ‹¼å›¾æ‰“åŒ…_${new Date().getTime()}.zip`); showLoading(false); })
        .catch(function(e) { if(!isCancelled) alert('æ‰“åŒ…å¤±è´¥: ' + e.message); showLoading(false); });
    }
    async function combineAndDownload() {
        if (!generatedBlobs.length) return;
        if (generatedBlobs.length === 1) { downloadBlob(generatedBlobs[0], 'æ‹¼å›¾_å®Œæ•´ç‰ˆ.jpg'); return; }
        showLoading(true, 'æ­£åœ¨åˆå¹¶...');
        try {
            const bitmaps = await Promise.all(generatedBlobs.map(b => createImageBitmap(b)));
            const totalH = bitmaps.reduce((sum, bmp) => sum + bmp.height, 0); const maxW = bitmaps[0].width;
            if(totalH > 30000) alert('è­¦å‘Šï¼šå›¾ç‰‡è¿‡é•¿ï¼Œå»ºè®®ä½¿ç”¨ZIPæ‰“åŒ…ã€‚');
            const canvas = document.createElement('canvas'); canvas.width = maxW; canvas.height = totalH;
            const ctx = canvas.getContext('2d'); let y = 0;
            for(let bmp of bitmaps) { if (isCancelled) break; ctx.drawImage(bmp, 0, y); y += bmp.height; }
            if(!isCancelled) { canvas.toBlob(blob => { if (isCancelled) return; downloadBlob(blob, `æ‹¼å›¾_åˆå¹¶ç‰ˆ_${new Date().getTime()}.jpg`); showLoading(false); }, 'image/jpeg', 0.9); }
        } catch(e) { if(!isCancelled) alert('åˆå¹¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ZIPæ‰“åŒ…ã€‚'); showLoading(false); }
    }
    function downloadAllParts() { if(!confirm('æ³¨æ„ï¼šæµè§ˆå™¨å¯èƒ½ä¼šæ‹¦æˆªæ‰¹é‡ä¸‹è½½ã€‚\nå»ºè®®ä½¿ç”¨ "ZIP æ‰“åŒ…"ã€‚\n\nç»§ç»­ï¼Ÿ')) return; generatedBlobs.forEach((blob, i) => { setTimeout(() => { const ext = blob.type === 'image/png' ? 'png' : 'jpg'; downloadBlob(blob, `æ‹¼å›¾_Part_${i+1}.${ext}`); }, i * 300); }); }
    function downloadBlob(blob, name) { const link = document.createElement('a'); link.download = name; link.href = URL.createObjectURL(blob); link.click(); }
    
    // åˆå§‹åŒ–æ¨¡å¼ï¼šé»˜è®¤è¿›å…¥â€œå°æ•°æ®é‡åˆ†ç»„â€æ¨¡å¼
    switchMode('small');
    // --- æ–°å¢ï¼šå¸®åŠ©ä¸­å¿ƒäº¤äº’é€»è¾‘ ---
function toggleHelpModal(show) {
    const modal = document.getElementById('helpModal');
    const content = document.getElementById('helpModalContent');
    
    if (show) {
        modal.style.display = 'flex';
        // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹åŠ åŠ¨ç”»ç±»ï¼Œè®©transitionç”Ÿæ•ˆ
        setTimeout(() => {
            content.classList.remove('translate-y-full');
        }, 10);
    } else {
        content.classList.add('translate-y-full');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300); // ç­‰å¾…åŠ¨ç”»ç»“æŸ
    }
}

function toggleHelpItem(id) {
    const content = document.getElementById(id);
    const icon = document.getElementById('icon-' + id);
    
    // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180'); // ç®­å¤´æ—‹è½¬
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}

</script>
</body>
</html>

